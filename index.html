<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Book Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        :root { --mouse-x: 0.5; --mouse-y: 0.5; }
        body { font-family: 'Inter', sans-serif; background-color: #fdf2f8; overflow-x: hidden; color: #4a044e; }

        /* Background & UI Styling */
        .floral-bg {
            position: fixed; top: -10%; left: -10%; width: 120%; height: 120%; z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23db2777' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"), radial-gradient(circle at 80% 20%, rgba(232, 121, 249, 0.4), transparent 40%), radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.3), transparent 40%);
            transform: translate(calc(var(--mouse-x) * -40px), calc(var(--mouse-y) * -40px));
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .card { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(16px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(162, 28, 175, 0.15); border: 1px solid rgba(255, 255, 255, 0.8); }
        .heading-font { font-family: 'Playfair Display', serif; }
        .tab-btn { position: relative; transition: all 0.3s; }
        .tab-btn::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background: linear-gradient(90deg, #d946ef, #8b5cf6); transition: width 0.3s; }
        .tab-active { color: #9333ea; font-weight: 700; }
        .tab-active::after { width: 100%; }
        .btn-gradient { background-image: linear-gradient(135deg, #d946ef 0%, #8b5cf6 100%); transition: all 0.3s ease; }
        .btn-gradient:hover { background-image: linear-gradient(135deg, #c026d3 0%, #7c3aed 100%); transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(147, 51, 234, 0.5); }
        .status-pending { background: #fff1f2; color: #be123c; border: 1px solid #fecdd3; }
        .status-processing { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .status-completed { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .status-delivered { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
        input, select, textarea { background: rgba(255, 255, 255, 0.9); border: 1px solid #e5e7eb; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: #d946ef; box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1); background: #fff; }
        .color-grid::-webkit-scrollbar { width: 4px; }
        .color-grid::-webkit-scrollbar-track { background: transparent; }
        .color-grid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .color-swatch.selected { transform: scale(1.1); border: 2px solid #4a044e; box-shadow: 0 0 0 2px #f0abfc; }
        .login-overlay { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: transparent; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #e9d5ff; border-radius: 10px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #d8b4fe; }
    </style>
</head>
<body class="p-4 md:p-8 relative min-h-screen text-slate-800">

    <div class="floral-bg"></div>

    <div id="login-screen" class="fixed inset-0 z-[100] login-overlay flex flex-col items-center justify-center p-4">
        <div class="bg-white/80 p-10 rounded-3xl shadow-2xl border border-white max-w-md w-full text-center backdrop-blur-xl">
            <h1 class="text-4xl font-bold text-fuchsia-900 mb-2 heading-font">Boutique Book</h1>
            <p class="text-fuchsia-600/80 mb-8 font-medium">Elegant Management for Fashion</p>
            <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border border-fuchsia-100 hover:bg-fuchsia-50 text-fuchsia-900 font-bold py-4 px-6 rounded-2xl transition shadow-lg cursor-pointer transform hover:scale-[1.02]">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                Sign in with Google
            </button>
            <p class="text-xs text-slate-400 mt-4">Syncs with Google Drive & Sheets</p>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-bold text-fuchsia-950 tracking-tight flex items-center gap-2 heading-font drop-shadow-sm">
                    Boutique Book 
                </h1>
                <div class="flex items-center gap-2 mt-2">
                    <div class="flex items-center px-3 py-1 bg-white/70 rounded-full border border-white/50 shadow-sm backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
                        <p id="user-display" class="text-emerald-800 text-xs font-bold uppercase tracking-wide">Connecting...</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="logout()" class="px-5 py-2.5 rounded-xl bg-white/80 text-rose-600 hover:bg-white border border-rose-100 shadow-sm transition text-sm font-bold backdrop-blur-md">Sign Out</button>
                <button onclick="exportCSV()" class="px-5 py-2.5 rounded-xl bg-white/80 text-violet-700 hover:bg-white border border-violet-100 shadow-sm transition text-sm font-bold flex items-center gap-2 backdrop-blur-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Export
                </button>
                <button onclick="openOrderModal()" class="px-6 py-2.5 rounded-xl btn-gradient text-white shadow-lg shadow-fuchsia-200 transition font-bold flex items-center gap-2 text-sm tracking-wide">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> NEW ORDER
                </button>
            </div>
        </header>

        <div class="flex gap-8 border-b border-fuchsia-200/50 mb-10 overflow-x-auto px-2">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-3 px-2 font-medium text-slate-500 tab-btn tab-active hover:text-fuchsia-700">Overview</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="pb-3 px-2 font-medium text-slate-500 tab-btn hover:text-fuchsia-700">All Orders</button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="pb-3 px-2 font-medium text-slate-500 tab-btn hover:text-fuchsia-700">Financial Insights</button>
        </div>

        <div id="section-dashboard" class="space-y-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-t-4 border-fuchsia-500">
                    <p class="text-xs font-bold text-fuchsia-400 uppercase tracking-wider">Total Revenue</p>
                    <p id="stat-revenue" class="text-3xl font-bold text-slate-800 heading-font mt-1">‚Çπ0</p>
                </div>
                <div class="card p-6 border-t-4 border-emerald-500">
                    <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider">Net Profit</p>
                    <p id="stat-profit" class="text-3xl font-bold text-emerald-700 heading-font mt-1">‚Çπ0</p>
                </div>
                <div class="card p-6 border-t-4 border-amber-500">
                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider">Pending</p>
                    <p id="stat-pending" class="text-3xl font-bold text-amber-600 heading-font mt-1">0</p>
                </div>
                <div class="card p-6 border-t-4 border-violet-500">
                    <p class="text-xs font-bold text-violet-500 uppercase tracking-wider">Margin</p>
                    <p id="stat-margin" class="text-3xl font-bold text-violet-600 heading-font mt-1">0%</p>
                </div>
            </div>

            <div id="urgent-container" class="hidden">
                <div class="bg-rose-50/80 backdrop-blur border border-rose-200 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-rose-700 mb-3 flex items-center gap-2 uppercase tracking-wide">
                        <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                        Upcoming Deliveries (3 Days)
                    </h3>
                    <div id="urgent-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <div class="card p-8">
                <h3 class="text-xl font-bold text-fuchsia-900 mb-6 heading-font">Recent Activity</h3>
                <div id="quick-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <div id="section-orders" class="hidden card overflow-hidden fade-in">
            <div class="p-6 border-b border-fuchsia-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white/40">
                <h2 class="text-xl font-bold text-fuchsia-900 heading-font">Order Management</h2>
                <div class="flex gap-3 w-full md:w-auto">
                    <select id="filterStatus" onchange="renderOrders()" class="rounded-xl px-4 py-2 text-sm text-fuchsia-900 font-medium cursor-pointer">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <input type="text" id="searchOrders" placeholder="Search customer, item..." class="rounded-xl px-4 py-2 text-sm flex-grow md:w-64" onkeyup="renderOrders()">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-fuchsia-50/50 text-fuchsia-900/60 uppercase text-xs font-bold tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Client</th>
                            <th class="px-6 py-4">Item & Status</th>
                            <th class="px-6 py-4">Schedule</th>
                            <th class="px-6 py-4 text-right">Financials</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody" class="divide-y divide-fuchsia-100/50">
                        <tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Connecting to secure cloud...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="section-analytics" class="hidden space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-fuchsia-900 heading-font mb-6 border-b border-fuchsia-100 pb-2">Cost Breakdown</h3>
                    <div id="analytics-costs" class="space-y-5"></div>
                </div>
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-fuchsia-900 heading-font mb-6 border-b border-fuchsia-100 pb-2">Business Health</h3>
                    <div class="space-y-6 pt-2">
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Avg Profit/Order</span><span id="stat-avg-profit" class="font-bold text-slate-800 text-lg">‚Çπ0</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Top Category</span><span id="stat-top-item" class="font-bold text-violet-600 text-lg">-</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Completion Rate</span><span id="stat-conversion" class="font-bold text-emerald-600 text-lg">0%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-fuchsia-950/40 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-5xl w-full max-h-[95vh] overflow-y-auto shadow-2xl modal-scroll border border-white/60">
            <div class="sticky top-0 bg-white/95 backdrop-blur px-8 py-6 border-b border-fuchsia-100 flex justify-between items-center z-10">
                <div>
                    <h2 class="text-2xl font-bold text-fuchsia-950 heading-font" id="modalTitle">Create New Order</h2>
                    <p class="text-xs text-fuchsia-400 mt-1 font-medium tracking-wide" id="orderIdDisplay">ID Generated Automatically</p>
                </div>
                <button onclick="closeOrderModal()" class="text-slate-400 hover:text-rose-500 text-3xl transition transform hover:rotate-90">&times;</button>
            </div>
            
            <div class="p-8 space-y-8">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Customer Name *</label>
                        <input type="text" id="custName" class="w-full rounded-xl p-3" placeholder="Jane Doe">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">WhatsApp Number</label>
                        <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden bg-white/90">
                            <span class="bg-fuchsia-50 text-fuchsia-700 px-3 py-3 border-r border-fuchsia-100 text-sm font-bold">+91</span>
                            <input type="tel" id="custPhone" class="w-full p-3 outline-none bg-transparent" placeholder="9876543210">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Status</label>
                        <select id="orderStatus" class="w-full rounded-xl p-3 cursor-pointer">
                            <option value="Pending">üïí Pending</option>
                            <option value="Processing">‚úÇÔ∏è Processing</option>
                            <option value="Completed">‚úÖ Completed</option>
                            <option value="Delivered">üì¶ Delivered</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Delivery Address</label>
                        <textarea id="custAddress" rows="2" class="w-full rounded-xl p-3" placeholder="Full address details..."></textarea>
                    </div>
                    
                    <div class="md:col-span-3 grid grid-cols-10 gap-4">
                        <div class="col-span-4 md:col-span-3 flex flex-col p-4 border border-fuchsia-100 rounded-2xl bg-white shadow-sm h-64">
                            <label class="text-[10px] font-bold text-fuchsia-800 uppercase mb-2 flex justify-between">
                                <span>Neelam Shade Card</span>
                                <span id="selectedColorName" class="text-fuchsia-500">Select...</span>
                            </label>
                            <input type="hidden" id="orderColor" value="#ffffff">
                            <div id="neelamGrid" class="color-grid grid grid-cols-5 gap-2 overflow-y-auto flex-1 pr-1 content-start"></div>
                            <div class="mt-2 pt-2 border-t border-slate-100">
                                <label class="text-[9px] text-slate-400 block mb-1">Custom Shade</label>
                                <input type="color" id="customColorPicker" class="w-full h-6 rounded cursor-pointer" onchange="selectCustomColor(this.value)">
                            </div>
                        </div>

                        <div class="col-span-6 md:col-span-7 border-2 border-dashed border-fuchsia-200 rounded-2xl p-6 text-center hover:border-fuchsia-400 transition bg-fuchsia-50/30 cursor-pointer flex flex-col items-center justify-center h-64" onclick="document.getElementById('designImageInput').click()">
                            <label class="block text-xs font-bold text-fuchsia-400 uppercase mb-2 cursor-pointer">Design / Fabric Photo</label>
                            <input type="file" id="designImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                            <div id="imagePreviewArea" class="flex flex-col items-center justify-center w-full h-full">
                                <div id="uploadPlaceholder">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-fuchsia-300 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    <span class="text-sm text-fuchsia-600 font-medium bg-white px-4 py-1 rounded-full shadow-sm">Click to upload</span>
                                </div>
                                <img id="designPreview" class="hidden max-h-full max-w-full rounded-xl shadow-lg border-4 border-white object-contain">
                                <input type="hidden" id="designImageBase64">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Item Category *</label>
                        <input type="text" id="itemType" placeholder="e.g., Silk Saree" class="w-full rounded-xl p-3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Order Date</label>
                        <input type="date" id="dateOrder" class="w-full rounded-xl p-3 text-slate-600">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Delivery Due</label>
                        <input type="date" id="dateDelivery" class="w-full rounded-xl p-3 text-slate-600">
                    </div>
                </div>

                <div class="bg-fuchsia-50/50 p-6 rounded-2xl border border-fuchsia-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-fuchsia-900 flex items-center gap-2 text-sm uppercase tracking-wide">
                            <span class="bg-white p-1 rounded shadow-sm text-fuchsia-500">üìè</span> Measurements (Inches)
                        </h3>
                        <button onclick="addCustomMeasurement()" class="px-3 py-1 bg-white border border-fuchsia-200 text-fuchsia-600 rounded-lg text-xs font-bold hover:bg-fuchsia-100 transition shadow-sm">+ Custom</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="measurementsContainer">
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Length</label><input type="text" id="mLength" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Chest</label><input type="text" id="mBust" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Waist</label><input type="text" id="mWaist" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Shoulder</label><input type="text" id="mShoulder" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Sleeve</label><input type="text" id="mSleeve" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Neck</label><input type="text" id="mNeck" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Hip</label><input type="text" id="mHip" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Other</label><input type="text" id="mOther" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                    </div>
                </div>

                <div class="bg-violet-50/50 p-6 rounded-2xl border border-violet-100">
                    <h3 class="font-bold text-violet-900 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <span class="bg-white p-1 rounded shadow-sm text-violet-500">üí∞</span> Costing & Billing
                    </h3>
                    
                    <div class="bg-white p-4 rounded-xl border border-violet-100 mb-4 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-violet-400 uppercase">Fabric Calculator</label>
                            <button onclick="addFabricRow()" class="text-xs bg-violet-100 text-violet-600 px-2 py-1 rounded font-bold hover:bg-violet-200 transition">+ Add Fabric</button>
                        </div>
                        <div class="grid grid-cols-12 gap-2 mb-2 text-[10px] font-bold text-slate-400 uppercase px-1">
                            <div class="col-span-3">Type</div>
                            <div class="col-span-2">Price/M</div>
                            <div class="col-span-2">Meters</div>
                            <div class="col-span-2">Dyeing</div>
                            <div class="col-span-2">Total</div>
                            <div class="col-span-1"></div>
                        </div>
                        <div id="fabricRowsContainer" class="space-y-2"></div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
                        <div><label class="text-xs font-bold text-slate-400">Total Fabric</label><input type="number" id="costFabric" value="0" class="w-full rounded-lg p-2 mt-1 bg-slate-50 font-bold text-slate-600" readonly></div>
                        <div><label class="text-xs font-bold text-slate-400">Extra Dyeing</label><input type="number" id="costDye" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Labor/Stitching</label><input type="number" id="costLabor" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Handwork</label><input type="number" id="costHandwork" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Packing</label><input type="number" id="costPacking" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                    </div>
                    
                    <div class="border-t border-violet-200/50 my-6 pt-6 grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Total Expenses</label>
                            <p id="displayTotalCost" class="text-xl font-bold text-slate-500 mt-1">‚Çπ0</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-violet-700 uppercase">Final Sale Price *</label>
                            <input type="number" id="salePrice" class="w-full border-2 border-violet-300 rounded-xl p-3 mt-1 font-bold text-lg text-violet-900" oninput="calcTotal()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-fuchsia-700 uppercase">Delivery Charge</label>
                            <input type="number" id="deliveryCharge" value="0" class="w-full border-2 border-fuchsia-200 rounded-xl p-3 mt-1 font-bold text-fuchsia-700" oninput="calcTotal()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-emerald-700 uppercase">Advance Paid</label>
                            <input type="number" id="advance" value="0" class="w-full border-2 border-emerald-300 rounded-xl p-3 mt-1 font-bold text-emerald-700" oninput="calcTotal()">
                        </div>
                        <div class="md:col-span-4 text-right pt-2 flex justify-between items-center bg-white/50 p-4 rounded-xl border border-violet-100">
                            <div>
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider block">Estimated Profit</span>
                                <span id="displayProfit" class="text-xl font-bold text-emerald-600">‚Çπ0</span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold text-violet-500 uppercase tracking-wider block">Balance Due</span>
                                <span id="displayBalance" class="text-3xl font-bold text-violet-800">‚Çπ0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeOrderModal()" class="px-8 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 font-bold transition">Discard</button>
                    <button id="saveBtn" onclick="handleSave()" class="px-10 py-3.5 btn-gradient text-white rounded-xl shadow-lg shadow-violet-200 font-bold transition transform hover:scale-[1.02]">Save Order Record</button>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsappModal" class="fixed inset-0 bg-fuchsia-950/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-96 text-center border border-white">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
            </div>
            <h3 class="font-bold text-xl mb-1 text-slate-800 heading-font">Send Invoice</h3>
            <p class="text-sm text-slate-500 mb-8" id="wa-display-num"></p>
            <input type="hidden" id="wa-order-id">
            <button onclick="sendWhatsapp()" class="w-full py-4 bg-green-500 text-white rounded-2xl font-bold hover:bg-green-600 transition shadow-lg shadow-green-200 transform hover:scale-[1.02]">Download & Chat</button>
            <button onclick="document.getElementById('whatsappModal').classList.add('hidden')" class="w-full mt-4 py-2 text-slate-400 text-sm hover:text-slate-600 font-medium">Cancel</button>
        </div>
    </div>

    <script>
        document.addEventListener('mousemove', (e) => {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            document.body.style.setProperty('--mouse-x', x);
            document.body.style.setProperty('--mouse-y', y);
        });

        // --- GOOGLE SHEETS & DRIVE INTEGRATION ---
        async function checkForSpreadsheet(token) {
            const query = "name = 'Boutique Orders' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false";
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}`, {
                    method: 'GET', headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.files && data.files.length > 0) {
                    sessionStorage.setItem('sheet_id', data.files[0].id);
                } else {
                    createSpreadsheet(token);
                }
            } catch (e) { console.error("Error checking Drive:", e); }
        }

        async function createSpreadsheet(token) {
            const sheetBody = {
                properties: { title: "Boutique Orders" },
                sheets: [{ data: [{ startRow: 0, startColumn: 0, rowData: [{ values: [
                    { userEnteredValue: { stringValue: "Order ID" } }, { userEnteredValue: { stringValue: "Date" } },
                    { userEnteredValue: { stringValue: "Customer" } }, { userEnteredValue: { stringValue: "Phone" } },
                    { userEnteredValue: { stringValue: "Item" } }, { userEnteredValue: { stringValue: "Sale Price" } },
                    { userEnteredValue: { stringValue: "Delivery" } }, { userEnteredValue: { stringValue: "Advance" } },
                    { userEnteredValue: { stringValue: "Balance" } }, { userEnteredValue: { stringValue: "Status" } }
                ] }] }] }]
            };
            try {
                const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(sheetBody)
                });
                const data = await response.json();
                sessionStorage.setItem('sheet_id', data.spreadsheetId);
            } catch (e) { console.error("Error creating sheet:", e); }
        }

        async function appendToSheet(order) {
            const token = sessionStorage.getItem('google_access_token');
            const sheetId = sessionStorage.getItem('sheet_id');
            if (!token || !sheetId) return;

            const values = [[
                order.orderId, order.orderDate, order.customer, order.phone, order.item, 
                order.salePrice, order.deliveryCharge || 0, order.advance, 
                (order.salePrice + (order.deliveryCharge||0) - order.advance), order.status
            ]];

            try {
                await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/A1:append?valueInputOption=USER_ENTERED`, {
                    method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ values: values })
                });
            } catch (e) { console.error("Error syncing to sheet:", e); }
        }

        // --- NEELAM SHADE CARD DATA ---
        const neelamShades = [
            {hex: "#ef4444", name: "Red 01"}, {hex: "#dc2626", name: "Red 02"}, {hex: "#991b1b", name: "Maroon"},
            {hex: "#ec4899", name: "Rani Pink"}, {hex: "#d946ef", name: "Magenta"}, {hex: "#f472b6", name: "Baby Pink"},
            {hex: "#a855f7", name: "Purple"}, {hex: "#7e22ce", name: "Violet"}, {hex: "#4338ca", name: "Indigo"},
            {hex: "#3b82f6", name: "Royal Blue"}, {hex: "#0ea5e9", name: "Sky"}, {hex: "#1e3a8a", name: "Navy"},
            {hex: "#14b8a6", name: "Firozi"}, {hex: "#10b981", name: "Parrot"}, {hex: "#059669", name: "Rama Green"},
            {hex: "#064e3b", name: "Bottle Green"}, {hex: "#84cc16", name: "Lime"}, {hex: "#eab308", name: "Yellow"},
            {hex: "#ca8a04", name: "Mustard"}, {hex: "#f97316", name: "Orange"}, {hex: "#ea580c", name: "Rust"},
            {hex: "#78350f", name: "Brown"}, {hex: "#451a03", name: "Coffee"}, {hex: "#fbbf24", name: "Gold"},
            {hex: "#94a3b8", name: "Silver"}, {hex: "#0f172a", name: "Black"}, {hex: "#ffffff", name: "White"},
            {hex: "#f1f5f9", name: "Cream"}, {hex: "#fbcfe8", name: "Peach"}, {hex: "#c084fc", name: "Lavender"}
        ];

        function initNeelamChart() {
            const grid = document.getElementById('neelamGrid');
            grid.innerHTML = '';
            neelamShades.forEach(s => {
                const div = document.createElement('div');
                div.className = "color-swatch h-8 w-8 rounded-full cursor-pointer border border-slate-200 shadow-sm hover:scale-110 transition";
                div.style.backgroundColor = s.hex;
                div.title = s.name;
                div.onclick = () => selectColor(s.hex, s.name, div);
                grid.appendChild(div);
            });
        }

        function selectColor(hex, name, el) {
            document.getElementById('orderColor').value = hex;
            document.getElementById('selectedColorName').innerText = name || "Custom";
            document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('selected'));
            if(el) el.classList.add('selected');
        }

        function selectCustomColor(hex) { selectColor(hex, "Custom", null); }
        initNeelamChart();

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyCefM_p_lOAJilN0jDt3T5R5-FP4eKX9Ng",
            authDomain: "boutique-manager-hav.firebaseapp.com",
            projectId: "boutique-manager-hav",
            storageBucket: "boutique-manager-hav.firebasestorage.app",
            messagingSenderId: "1049576175326",
            appId: "1:1049576175326:web:68357d13c556102411b44f",
            measurementId: "G-L6G9WRCNXV",
            databaseURL: "https://boutique-manager-hav-default-rtdb.firebaseio.com"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let orders = [];

        const safe = (str) => str ? String(str).replace(/</g, '&lt;') : '';
        
        function googleLogin() { 
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/drive.file');
            provider.addScope('https://www.googleapis.com/auth/spreadsheets');
            auth.signInWithPopup(provider).then((result) => {
                const token = result.credential.accessToken;
                sessionStorage.setItem('google_access_token', token);
                checkForSpreadsheet(token);
            }).catch(e => alert(e.message)); 
        }
        function logout() { if(confirm("Log out?")) { auth.signOut(); location.reload(); } }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('user-display').innerText = user.displayName;
                db.ref('users/' + user.uid + '/orders').on('value', snap => {
                    const data = snap.val();
                    orders = data ? Object.values(data) : [];
                    renderOrders(); renderDashboard(); updateStats(); checkDeadlines();
                });
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // --- APP LOGIC ---
        function addFabricRow(type="", price="", meters="", dye="") {
            const div = document.createElement('div');
            div.className = "grid grid-cols-12 gap-2 fabric-row items-center";
            const isCustom = type && !['Silk','Cotton','Georgette','Velvet','Organza','Net','Crepe','Linen','Chiffon','Satin','Lining'].includes(type);
            div.innerHTML = `
                <div class="col-span-3 relative">
                    <select class="w-full rounded p-2 text-sm border-violet-100 fabric-type ${isCustom ? 'hidden' : ''}" onchange="checkOther(this)">
                        <option value="" disabled ${type===""?'selected':''}>Type</option>
                        ${['Silk','Cotton','Georgette','Velvet','Organza','Net','Crepe','Linen','Chiffon','Satin','Lining'].map(o => `<option value="${o}" ${type===o?'selected':''}>${o}</option>`).join('')}
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" value="${isCustom ? type : ''}" placeholder="Fabric Name" class="w-full rounded p-2 text-sm border-violet-100 fabric-custom-type ${isCustom ? '' : 'hidden'}" onblur="if(!this.value) {this.classList.add('hidden'); this.previousElementSibling.classList.remove('hidden'); this.previousElementSibling.value='';}">
                </div>
                <div class="col-span-2"><input type="number" placeholder="‚Çπ/M" value="${price}" class="w-full rounded p-2 text-sm border-violet-100 fabric-price" oninput="calcFabric()"></div>
                <div class="col-span-2"><input type="number" placeholder="Mtr" value="${meters}" class="w-full rounded p-2 text-sm border-violet-100 fabric-meter" oninput="calcFabric()"></div>
                <div class="col-span-2"><input type="number" placeholder="Dye" value="${dye}" class="w-full rounded p-2 text-sm border-violet-100 fabric-dye" oninput="calcFabric()"></div>
                <div class="col-span-2"><input type="text" value="0" class="w-full rounded p-2 text-sm bg-slate-50 border-none font-bold text-slate-500 fabric-subtotal" readonly></div>
                <div class="col-span-1 text-center"><button onclick="this.parentElement.parentElement.remove(); calcFabric()" class="text-red-400 font-bold hover:text-red-600">√ó</button></div>
            `;
            document.getElementById('fabricRowsContainer').appendChild(div);
            if(!isCustom && type) calcFabric(); 
        }

        function checkOther(select) { if(select.value === 'Other') { select.classList.add('hidden'); const input = select.nextElementSibling; input.classList.remove('hidden'); input.focus(); } }

        function calcFabric() {
            let total = 0;
            document.querySelectorAll('.fabric-row').forEach(row => {
                const p = parseFloat(row.querySelector('.fabric-price').value) || 0;
                const m = parseFloat(row.querySelector('.fabric-meter').value) || 0;
                const d = parseFloat(row.querySelector('.fabric-dye').value) || 0;
                const sub = (p * m) + d;
                row.querySelector('.fabric-subtotal').value = sub.toFixed(0);
                total += sub;
            });
            document.getElementById('costFabric').value = total.toFixed(2);
            calcTotal();
        }

        function addCustomMeasurement(label="", val="") {
            const div = document.createElement('div');
            div.className = "relative group custom-measure-row";
            div.innerHTML = `
                <input type="text" placeholder="Label" value="${label}" class="w-full mb-1 text-[10px] text-fuchsia-600 font-bold bg-transparent border-none p-0 custom-label">
                <input type="text" value="${val}" class="w-full rounded-lg p-2 text-sm border-fuchsia-200/50 custom-val">
                <button onclick="this.parentElement.remove()" class="absolute -top-1 -right-1 text-red-400 text-xs hidden group-hover:block bg-white rounded-full px-1">√ó</button>
            `;
            document.getElementById('measurementsContainer').appendChild(div);
        }

        function calcTotal() {
            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0; 
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const handwork = parseFloat(document.getElementById('costHandwork').value) || 0;
            const pack = parseFloat(document.getElementById('costPacking').value) || 0;
            
            const totalExpenses = fabric + dye + labor + handwork + pack;
            document.getElementById('displayTotalCost').innerText = `‚Çπ${totalExpenses.toFixed(2)}`;
            
            const sale = parseFloat(document.getElementById('salePrice').value) || 0;
            const deliveryCharge = parseFloat(document.getElementById('deliveryCharge').value) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            
            const profit = sale - totalExpenses; 
            const balance = (sale + deliveryCharge) - advance;

            document.getElementById('displayProfit').innerText = `‚Çπ${profit.toFixed(2)}`;
            document.getElementById('displayProfit').className = profit >= 0 ? "text-xl font-bold text-emerald-600" : "text-xl font-bold text-rose-600";
            document.getElementById('displayBalance').innerText = `‚Çπ${balance.toFixed(0)}`;
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    document.getElementById('designPreview').classList.remove('hidden');
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxWidth = 500; const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth; canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('designPreview').src = compressedBase64;
                        document.getElementById('designImageBase64').value = compressedBase64;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleSave() {
            if(!currentUser) return alert("Login required.");
            const cust = document.getElementById('custName').value;
            const item = document.getElementById('itemType').value;
            const price = document.getElementById('salePrice').value;
            if(!cust || !item || !price) return alert("Fill Name, Item, and Price.");

            const btn = document.getElementById('saveBtn'); btn.innerText = "Saving..."; btn.disabled = true;

            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0;
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const handwork = parseFloat(document.getElementById('costHandwork').value) || 0;
            const pack = parseFloat(document.getElementById('costPacking').value) || 0;
            const totalCost = fabric + dye + labor + handwork + pack; 

            const sale = parseFloat(price) || 0;
            const deliveryCharge = parseFloat(document.getElementById('deliveryCharge').value) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            const profit = sale - totalCost;

            const editId = document.getElementById('editId').value;
            const id = editId ? parseInt(editId) : Date.now();
            let orderIdStr;

            if (editId) {
                orderIdStr = orders.find(x => x.id == editId).orderId;
            } else {
                let maxId = 10000;
                if (orders.length > 0) orders.forEach(o => { const num = parseInt(o.orderId); if (!isNaN(num) && num > maxId) maxId = num; });
                orderIdStr = (maxId + 1).toString();
            }

            const fabricArr = [];
            document.querySelectorAll('.fabric-row').forEach(row => {
                const sel = row.querySelector('.fabric-type');
                const inp = row.querySelector('.fabric-custom-type');
                fabricArr.push({
                    type: (sel.classList.contains('hidden') ? inp.value : sel.value) || 'Unknown',
                    price: row.querySelector('.fabric-price').value,
                    meters: row.querySelector('.fabric-meter').value,
                    dye: row.querySelector('.fabric-dye').value
                });
            });

            const customMeas = [];
            document.querySelectorAll('.custom-measure-row').forEach(row => {
                const l = row.querySelector('.custom-label').value; const v = row.querySelector('.custom-val').value;
                if(l || v) customMeas.push({label: l, value: v});
            });

            const orderData = {
                id: id, orderId: orderIdStr, date: new Date().toLocaleDateString(),
                orderDate: document.getElementById('dateOrder').value,
                deliveryDate: document.getElementById('dateDelivery').value,
                customer: cust, phone: document.getElementById('custPhone').value,
                address: document.getElementById('custAddress').value,
                item: item, color: document.getElementById('orderColor').value,
                image: document.getElementById('designImageBase64').value,
                status: document.getElementById('orderStatus').value,
                measurements: {
                    len: document.getElementById('mLength').value, bust: document.getElementById('mBust').value,
                    waist: document.getElementById('mWaist').value, shoulder: document.getElementById('mShoulder').value,
                    sleeve: document.getElementById('mSleeve').value, neck: document.getElementById('mNeck').value,
                    hip: document.getElementById('mHip').value, other: document.getElementById('mOther').value, custom: customMeas
                },
                fabricDetails: fabricArr, costs: { fabric, dye, labor, handwork, pack, totalCost },
                salePrice: sale, deliveryCharge, advance, profit
            };

            db.ref('users/' + currentUser.uid + '/orders/' + id).set(orderData)
                .then(() => { 
                    appendToSheet(orderData); // Sync to Drive
                    closeOrderModal(); btn.innerText = "Save Order Record"; btn.disabled = false; 
                })
                .catch(err => { alert(err.message); btn.innerText = "Save Order Record"; btn.disabled = false; });
        }

        function deleteOrder(id) { if(confirm('Delete record?')) db.ref('users/' + currentUser.uid + '/orders/' + id).remove(); }

        function checkDeadlines() {
            const container = document.getElementById('urgent-orders');
            const alertBox = document.getElementById('urgent-container');
            container.innerHTML = '';
            const today = new Date();
            const urgent = orders.filter(o => {
                if(o.status === 'Completed' || o.status === 'Delivered' || !o.deliveryDate) return false;
                const diffTime = new Date(o.deliveryDate) - today;
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) <= 3; 
            });

            if(urgent.length > 0) {
                alertBox.classList.remove('hidden');
                urgent.forEach(o => {
                    const isOverdue = new Date(o.deliveryDate) < today;
                    container.innerHTML += `
                        <div class="bg-white/90 p-4 rounded-xl shadow-sm border-l-4 ${isOverdue ? 'border-rose-500' : 'border-amber-500'} flex justify-between items-center cursor-pointer hover:shadow-md transition" onclick="openOrderModal(${o.id})">
                            <div><p class="font-bold text-sm text-slate-800">${safe(o.customer)}</p><p class="text-xs font-bold ${isOverdue ? 'text-rose-600' : 'text-amber-600'}">${isOverdue ? 'OVERDUE' : 'Due: ' + o.deliveryDate}</p></div>
                            <span class="text-[10px] font-bold px-2 py-1 bg-slate-100 rounded text-slate-600">${safe(o.status)}</span>
                        </div>`;
                });
            } else { alertBox.classList.add('hidden'); }
        }

        function openOrderModal(editId=null) {
            document.querySelectorAll('#orderModal input, #orderModal textarea, #orderModal select').forEach(i=>i.value='');
            document.getElementById('designPreview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('designImageBase64').value = "";
            document.getElementById('orderStatus').value='Pending';
            document.getElementById('editId').value=editId||'';
            document.getElementById('modalTitle').innerText=editId?'Edit Order':'New Order';
            document.getElementById('fabricRowsContainer').innerHTML = ''; 
            document.querySelectorAll('.custom-measure-row').forEach(e => e.remove());
            document.getElementById('orderColor').value = "#ffffff";
            document.getElementById('selectedColorName').innerText = "Select...";
            document.querySelectorAll('.color-swatch').forEach(d => d.classList.remove('selected'));

            if(!editId) {
                document.getElementById('dateOrder').valueAsDate = new Date();
                let maxId = 10000;
                if (orders.length > 0) orders.forEach(o => { const num = parseInt(o.orderId); if (!isNaN(num) && num > maxId) maxId = num; });
                document.getElementById('orderIdDisplay').innerText = `ID: ${maxId + 1}`;
                addFabricRow();
            } else {
                const o = orders.find(x=>x.id==editId);
                if(o) {
                    document.getElementById('orderIdDisplay').innerText = `ID: ${o.orderId || o.id}`;
                    document.getElementById('custName').value=o.customer;
                    document.getElementById('custPhone').value=o.phone||'';
                    document.getElementById('custAddress').value=o.address||'';
                    document.getElementById('itemType').value=o.item;
                    document.getElementById('orderStatus').value=o.status;
                    document.getElementById('dateOrder').value=o.orderDate||'';
                    document.getElementById('dateDelivery').value=o.deliveryDate||'';
                    document.getElementById('salePrice').value=o.salePrice;
                    document.getElementById('deliveryCharge').value=o.deliveryCharge||0;
                    document.getElementById('advance').value=o.advance||0;
                    
                    if(o.color) {
                        document.getElementById('orderColor').value = o.color;
                        const match = neelamShades.find(s => s.hex === o.color);
                        if(match) {
                            document.getElementById('selectedColorName').innerText = match.name;
                            const els = document.querySelectorAll('.color-swatch');
                            els.forEach(el => { if(el.title === match.name) el.classList.add('selected'); });
                        } else {
                            document.getElementById('selectedColorName').innerText = "Custom";
                            document.getElementById('customColorPicker').value = o.color;
                        }
                    }

                    const c = o.costs || {};
                    document.getElementById('costDye').value=c.dye||0;
                    document.getElementById('costLabor').value=c.labor||0;
                    document.getElementById('costHandwork').value=c.handwork||0;
                    document.getElementById('costPacking').value=c.pack||0;
                    
                    if(o.fabricDetails && Array.isArray(o.fabricDetails)) {
                        o.fabricDetails.forEach(f => addFabricRow(f.type, f.price, f.meters, f.dye));
                    } else if(o.fabricDetails && !Array.isArray(o.fabricDetails)) {
                        addFabricRow(o.fabricDetails.type, o.fabricDetails.price, o.fabricDetails.meters, 0);
                    } else { addFabricRow(); }

                    if(o.image) {
                        document.getElementById('designPreview').src = o.image;
                        document.getElementById('designPreview').classList.remove('hidden');
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                        document.getElementById('designImageBase64').value = o.image;
                    }

                    if(o.measurements) {
                        const m=o.measurements;
                        document.getElementById('mLength').value=m.len||''; document.getElementById('mBust').value=m.bust||'';
                        document.getElementById('mWaist').value=m.waist||''; document.getElementById('mShoulder').value=m.shoulder||'';
                        document.getElementById('mSleeve').value=m.sleeve||''; document.getElementById('mNeck').value=m.neck||'';
                        document.getElementById('mHip').value=m.hip||''; document.getElementById('mOther').value=m.other||'';
                        if(m.custom && Array.isArray(m.custom)) m.custom.forEach(cm => addCustomMeasurement(cm.label, cm.value));
                    }
                    calcFabric();
                }
            }
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function closeOrderModal() { document.getElementById('orderModal').classList.add('hidden'); }

        function renderOrders() {
            const term = document.getElementById('searchOrders').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            const filtered = orders.filter(o => {
                const matchSearch = (o.customer||'').toLowerCase().includes(term) || (o.item||'').toLowerCase().includes(term) || (o.orderId||'').toString().toLowerCase().includes(term);
                const matchStatus = status === 'all' || o.status === status;
                return matchSearch && matchStatus;
            }).sort((a,b) => b.id - a.id);

            if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">No active orders found.</td></tr>`; return; }

            filtered.forEach(o => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-fuchsia-50/50 border-b border-fuchsia-100/50 transition duration-200 group";
                const today = new Date();
                let dateStyle = "text-slate-500";
                if(o.deliveryDate) {
                    const due = new Date(o.deliveryDate);
                    if(due < today && o.status !== 'Delivered') dateStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded";
                }

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${safe(o.customer)}</div>
                        <div class="text-[10px] text-slate-400 font-mono tracking-wider">${o.orderId || o.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full shadow-sm border border-slate-200" style="background-color: ${o.color || '#fff'};" title="Color"></div>
                            <div class="font-semibold text-slate-700 text-sm">${safe(o.item)}</div>
                        </div>
                        <span class="text-[10px] font-bold px-2.5 py-1 rounded-full ${getStatusClass(o.status)} mt-1 inline-block">${safe(o.status)}</span>
                    </td>
                    <td class="px-6 py-4 text-xs ${dateStyle}">
                        <div class="flex flex-col gap-1">
                            <span>üìÖ Ord: ${o.orderDate || '-'}</span>
                            <span>üöö Del: ${o.deliveryDate || '-'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-sm font-bold text-slate-800">‚Çπ${o.salePrice}</div>
                        <div class="text-[10px] font-bold ${o.profit>=0?'text-emerald-500':'text-rose-500'}">PROFIT: ‚Çπ${o.profit?.toFixed(0)}</div>
                    </td>
                    <td class="px-6 py-4 flex justify-center gap-2 opacity-80 group-hover:opacity-100 transition">
                        <button onclick="printInvoice(${o.id})" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded-lg transition" title="Invoice"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button>
                        <button onclick="openWhatsappModal(${o.id})" class="text-green-500 hover:bg-green-50 p-2 rounded-lg transition" title="WhatsApp"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.001.572 2.135.882 3.322.882 3.181 0 5.768-2.587 5.768-5.766-2.001-3.18-2.588-6.065-6.284-6.065z"/></svg></button>
                        <button onclick="openOrderModal(${o.id})" class="text-violet-500 hover:bg-violet-50 p-2 rounded-lg transition" title="Edit"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                        <button onclick="deleteOrder(${o.id})" class="text-rose-400 hover:bg-rose-50 p-2 rounded-lg transition" title="Delete"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchTab(t){ ['dashboard','orders','analytics'].forEach(s=>{ document.getElementById('section-'+s).classList.add('hidden'); document.getElementById('tab-'+s).classList.remove('tab-active'); }); document.getElementById('section-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('tab-active'); if(t==='analytics') renderAnalytics(); if(t==='dashboard') { renderDashboard(); checkDeadlines(); } }
        function updateStats(){ const rev=orders.reduce((s,o)=>s+(o.salePrice||0),0); const pro=orders.reduce((s,o)=>s+(o.profit||0),0); const pen=orders.filter(o=>o.status==='Pending'||o.status==='Processing').length; document.getElementById('stat-revenue').innerText=`‚Çπ${rev.toLocaleString()}`; document.getElementById('stat-profit').innerText=`‚Çπ${pro.toLocaleString()}`; document.getElementById('stat-pending').innerText=pen; document.getElementById('stat-margin').innerText=rev>0?(pro/rev*100).toFixed(1)+'%':'0%'; }
        function renderDashboard(){ const c=document.getElementById('quick-orders'); c.innerHTML=''; orders.slice(0,6).forEach(o=>{ c.innerHTML+=`<div onclick="switchTab('orders')" class="p-4 border-l-4 border-fuchsia-400 bg-white/80 rounded-r-xl flex justify-between items-center hover:bg-white cursor-pointer transition shadow-sm"><div><p class="font-bold text-slate-800 text-sm">${safe(o.customer)}</p><p class="text-xs text-slate-500">${safe(o.item)}</p></div><span class="text-[10px] font-bold px-2 py-1 rounded ${getStatusClass(o.status)}">${safe(o.status)}</span></div>`}); }
        function renderAnalytics() {
            const totals = orders.reduce((acc, o) => {
                const c = o.costs || {};
                acc.fabric += c.fabric || 0; acc.dye += c.dye || 0; acc.labor += c.labor || 0;
                acc.handwork += c.handwork || 0; acc.pack += c.pack || 0;
                return acc;
            }, { fabric:0, dye:0, labor:0, handwork:0, pack:0 });
            
            const totalExp = Object.values(totals).reduce((a,b)=>a+b,0);
            const getPct = (v) => totalExp > 0 ? (v/totalExp*100).toFixed(0) : 0;

            const container = document.getElementById('analytics-costs');
            container.innerHTML = `
                ${renderProgressBar('Fabric', totals.fabric, 'bg-blue-400', getPct(totals.fabric))}
                ${renderProgressBar('Labor/Stitching', totals.labor, 'bg-slate-400', getPct(totals.labor))}
                ${renderProgressBar('Handwork', totals.handwork, 'bg-purple-400', getPct(totals.handwork))}
                ${renderProgressBar('Dyeing', totals.dye, 'bg-amber-400', getPct(totals.dye))}
            `;
        }
        function renderProgressBar(l,v,c,p){ return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold text-slate-600"><span class="uppercase tracking-wide">${l}</span><span>‚Çπ${v.toLocaleString()} (${p}%)</span></div><div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="${c} h-2.5 rounded-full transition-all duration-500" style="width:${p}%"></div></div></div>`; }
        function getStatusClass(s) { if(s=='Pending')return'status-pending'; if(s=='Processing')return'status-processing'; if(s=='Completed')return'status-completed'; return 'status-delivered'; }

        function printInvoice(id){ 
            const o=orders.find(x=>x.id==id); if(!o)return; 
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); 
            doc.setFontSize(26); doc.setTextColor(134, 25, 143); doc.setFont("helvetica", "bold"); doc.text("INVOICE", 160, 25);
            doc.setFontSize(18); doc.setTextColor(74, 4, 78); doc.text("Boutique Book", 14, 25);
            doc.setDrawColor(240, 171, 252); doc.line(14, 35, 196, 35);
            
            doc.setFontSize(10); doc.setTextColor(100); doc.setFont("helvetica", "normal");
            doc.text(`Date: ${o.orderDate || o.date}`, 160, 45); doc.text(`ID: ${o.orderId || o.id}`, 160, 50);
            
            doc.setFontSize(11); doc.setTextColor(0); doc.setFont("helvetica", "bold"); doc.text(`Billed To:`, 14, 45);
            doc.setFont("helvetica", "normal"); doc.text(`${o.customer}`, 14, 52);
            doc.text(`+91 ${o.phone}`, 14, 58);
            const splitAddr = doc.splitTextToSize(o.address || '', 60);
            doc.text(splitAddr, 14, 64);

            if (o.measurements) {
                const m = o.measurements;
                doc.autoTable({ startY: 85, head: [['Length', 'Chest', 'Waist', 'Shldr', 'Sleeve']], body: [[m.len||'-', m.bust||'-', m.waist||'-', m.shoulder||'-', m.sleeve||'-']], theme: 'plain', styles: { fontSize: 9, cellPadding: 3 }, headStyles: { fontStyle: 'bold', textColor: 100 } });
                
                if(m.custom && m.custom.length > 0) {
                   let customBody = [];
                   let row = [];
                   m.custom.forEach((cm, i) => {
                       row.push(`${cm.label}: ${cm.value}`);
                       if((i+1) % 3 === 0) { customBody.push(row); row = []; }
                   });
                   if(row.length > 0) customBody.push(row);
                   doc.autoTable({ startY: doc.lastAutoTable.finalY + 5, body: customBody, theme: 'plain', styles: { fontSize: 8, fontStyle: 'italic', cellPadding: 1 } });
                }
            }

            let itemDesc = o.item;
            if(o.fabricDetails && Array.isArray(o.fabricDetails)) {
                const fabricNames = o.fabricDetails.map(f => f.type).join(", ");
                if(fabricNames) itemDesc += ` (${fabricNames})`;
            }

            doc.autoTable({
                startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 90,
                head: [['Item / Description', 'Due Date', 'Price']],
                body: [[itemDesc, o.deliveryDate||'-', `Rs. ${o.salePrice}`]],
                theme: 'striped', headStyles: { fillColor: [192, 38, 211], textColor: 255 }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total:`, 150, finalY); doc.text(`Rs. ${o.salePrice}`, 190, finalY, {align:'right'});
            doc.text(`Delivery Charge:`, 150, finalY+6); doc.text(`+ Rs. ${o.deliveryCharge||0}`, 190, finalY+6, {align:'right'});
            doc.text(`Advance:`, 150, finalY+12); doc.text(`- Rs. ${o.advance||0}`, 190, finalY+12, {align:'right'});
            doc.setDrawColor(200); doc.line(150, finalY+15, 190, finalY+15);
            doc.setFont("helvetica", "bold"); doc.setTextColor(134, 25, 143);
            doc.text(`Due:`, 150, finalY+22); doc.text(`Rs. ${(o.salePrice + (o.deliveryCharge||0) - (o.advance||0))}`, 190, finalY+22, {align:'right'});
            
            doc.setFont("helvetica", "italic"); doc.setFontSize(8); doc.setTextColor(150);
            doc.text("Thank you for your business. No refunds on custom orders.", 105, 280, {align:'center'});

            doc.save(`Invoice_${o.customer}_${o.orderId}.pdf`); 
        }

        function openWhatsappModal(id) {
            const o = orders.find(x => x.id === id);
            if(!o.phone) return alert("No phone number.");
            document.getElementById('wa-display-num').innerText = "Send to: +91 " + o.phone;
            document.getElementById('wa-order-id').value = id;
            document.getElementById('whatsappModal').classList.remove('hidden');
        }

        function sendWhatsapp() {
            const id = parseInt(document.getElementById('wa-order-id').value);
            const o = orders.find(x => x.id === id);
            printInvoice(id);
            const balance = (o.salePrice + (o.deliveryCharge||0) - (o.advance || 0));
            const msg = `*INVOICE: ${o.orderId}* %0A-----------------%0AItem: ${o.item}%0ATotal: ‚Çπ${o.salePrice}%0ADelivery: ‚Çπ${o.deliveryCharge||0}%0AAdvance: ‚Çπ${o.advance||0}%0A*Balance Due: ‚Çπ${balance}*%0A-----------------%0APlease find your invoice attached.`;
            setTimeout(() => { window.open(`https://wa.me/91${o.phone}?text=${msg}`, '_blank'); document.getElementById('whatsappModal').classList.add('hidden'); }, 1000);
        }

        function exportCSV() {
            if (!orders.length) return alert("No data.");
            const headers = ["Order ID", "Date", "Customer", "Phone", "Address", "Item", "Status", "Delivery Date", "Sale Price", "Delivery Chg", "Advance", "Profit", "Fabric Cost", "Dye Cost", "Handwork", "Labor", "Packing"];
            const rows = orders.map(o => {
                const c = o.costs || {};
                const esc = (t) => `"${String(t || '').replace(/"/g, '""')}"`;
                return [
                    o.orderId, o.orderDate, esc(o.customer), esc(o.phone), esc(o.address), esc(o.item), esc(o.status), o.deliveryDate,
                    o.salePrice, o.deliveryCharge, o.advance, o.profit, c.fabric, c.dye, c.handwork, c.labor, c.pack
                ].join(",");
            });
            const csv = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
            a.download = `Boutique_Orders_${new Date().toLocaleDateString()}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
