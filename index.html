<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Management System Pro + AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-active { border-bottom: 2px solid #8b5cf6; color: #8b5cf6; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-delivered { background-color: #f3f4f6; color: #374151; }
        .ai-shimmer {
            background: linear-gradient(90deg, #f3e8ff 0%, #e0e7ff 50%, #f3e8ff 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                    Boutique Manager 
                    <span class="bg-gradient-to-r from-violet-600 to-indigo-600 text-white text-[10px] uppercase font-bold px-2 py-1 rounded-full">AI Enhanced</span>
                </h1>
                <p class="text-slate-500">Intelligent inventory, measurement, and profit tracking</p>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="exportData()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition text-sm font-medium">Export CSV</button>
                <button onclick="document.getElementById('importFile').click()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition text-sm font-medium">Import</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
                <button onclick="openOrderModal()" class="px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700 shadow-md shadow-violet-200 transition font-medium">+ New Order</button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex gap-8 border-b mb-8 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-3 px-2 font-medium text-slate-500 tab-active">Overview</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="pb-3 px-2 font-medium text-slate-500">All Orders</button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="pb-3 px-2 font-medium text-slate-500">Financial Insights</button>
            <button onclick="switchTab('ai-studio')" id="tab-ai-studio" class="pb-3 px-2 font-medium text-slate-500 flex items-center gap-1">
                ‚ú® Design Studio
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="section-dashboard" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-b-4 border-violet-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Revenue</p>
                    <p id="stat-revenue" class="text-3xl font-bold text-slate-800">‚Çπ0</p>
                </div>
                <div class="card p-6 border-b-4 border-emerald-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Net Profit</p>
                    <p id="stat-profit" class="text-3xl font-bold text-emerald-600">‚Çπ0</p>
                </div>
                <div class="card p-6 border-b-4 border-amber-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pending Orders</p>
                    <p id="stat-pending" class="text-3xl font-bold text-amber-600">0</p>
                </div>
                <div class="card p-6 border-b-4 border-blue-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Profit Margin</p>
                    <p id="stat-margin" class="text-3xl font-bold text-blue-600">0%</p>
                </div>
            </div>

            <!-- Recent Activity Mini Table -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800">Quick Status Update</h3>
                </div>
                <div id="quick-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div id="section-orders" class="hidden card overflow-hidden">
            <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800">Order Management</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="filterStatus" onchange="renderOrders()" class="border rounded-md px-3 py-2 text-sm bg-white">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <input type="text" id="searchOrders" placeholder="Search name or item..." class="border rounded-md px-3 py-2 text-sm flex-grow md:w-64" onkeyup="renderOrders()">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold">
                        <tr>
                            <th class="px-6 py-4">Customer & Date</th>
                            <th class="px-6 py-4">Item & Status</th>
                            <th class="px-6 py-4">Measurements</th>
                            <th class="px-6 py-4 text-right">Profit Analysis</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody" class="divide-y divide-slate-100">
                        <!-- Content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="section-analytics" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <h3 class="text-lg font-bold text-slate-800 font-semibold">Expense Distribution</h3>
                        <button onclick="aiBusinessAdvice()" class="text-xs bg-violet-100 text-violet-700 px-2 py-1 rounded-md font-bold hover:bg-violet-200 transition">‚ú® Get Growth Advice</button>
                    </div>
                    <div id="analytics-costs" class="space-y-4">
                        <!-- Cost bars -->
                    </div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 font-semibold border-b pb-2">Business Health</h3>
                    <div class="space-y-6 pt-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500">Average Profit Per Order</span>
                            <span id="stat-avg-profit" class="font-bold text-slate-800">‚Çπ0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500">Most Profitable Item</span>
                            <span id="stat-top-item" class="font-bold text-violet-600">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500">Conversion Rate (Completed)</span>
                            <span id="stat-conversion" class="font-bold text-emerald-600">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="ai-advice-container" class="hidden card p-6 border-2 border-violet-100 bg-violet-50/30">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl">‚ú®</span>
                    <h4 class="font-bold text-violet-800">Gemini Business Consultant</h4>
                </div>
                <p id="ai-advice-text" class="text-slate-700 text-sm italic leading-relaxed whitespace-pre-line"></p>
            </div>
        </div>

        <!-- AI Studio Section -->
        <div id="section-ai-studio" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6 md:col-span-1">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">‚ú® AI Fashion Designer</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">What are we making?</label>
                            <input type="text" id="ai-item-input" placeholder="e.g. Silk Anarkali with Gota Patti" class="w-full border rounded-lg p-2 text-sm mt-1 focus:ring-2 focus:ring-violet-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase">Customer Preference</label>
                            <textarea id="ai-pref-input" placeholder="e.g. Modern look but traditional fabric, heavy border" class="w-full border rounded-lg p-2 text-sm mt-1 h-24 focus:ring-2 focus:ring-violet-500 outline-none"></textarea>
                        </div>
                        <button onclick="generateDesignIdeas()" id="designBtn" class="w-full py-3 bg-violet-600 text-white rounded-xl font-bold hover:bg-violet-700 transition">‚ú® Generate Design Concepts</button>
                    </div>
                </div>
                <div class="card p-6 md:col-span-2 min-h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">Concept Board</h3>
                    <div id="ai-design-output" class="text-slate-600 text-sm leading-relaxed overflow-y-auto flex-grow flex items-center justify-center italic text-slate-400">
                        Enter details to see AI-generated design suggestions and fabric combinations...
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="orderModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white px-8 py-5 border-b flex justify-between items-center z-10">
                    <h2 class="text-2xl font-bold text-slate-800" id="modalTitle">Create New Order</h2>
                    <div class="flex gap-2">
                        <button onclick="aiAuditMeasurements()" class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold border border-indigo-100 hover:bg-indigo-100 transition">‚ú® AI Audit</button>
                        <button onclick="closeOrderModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                    </div>
                </div>
                
                <form id="orderForm" onsubmit="saveOrder(event)" class="p-8 space-y-8">
                    <input type="hidden" id="editId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Name</label>
                            <input type="text" id="custName" required class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none transition bg-slate-50">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Item Category</label>
                            <input type="text" id="itemType" required placeholder="e.g., Anarkali" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none transition bg-slate-50">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Status</label>
                            <select id="orderStatus" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none bg-slate-50">
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="Completed">Completed</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                    </div>

                    <div id="measurement-audit-result" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-xl text-xs text-amber-800 italic"></div>

                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="p-1.5 bg-white rounded-md shadow-sm">üìè</span> Precision Measurements (Inches)
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Length</label><input type="text" id="mLength" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Chest</label><input type="text" id="mBust" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Waist</label><input type="text" id="mWaist" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Shoulder</label><input type="text" id="mShoulder" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Sleeve</label><input type="text" id="mSleeve" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Neck (F/B)</label><input type="text" id="mNeck" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Hip</label><input type="text" id="mHip" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Other</label><input type="text" id="mOther" class="w-full border rounded-lg p-2 mt-1"></div>
                        </div>
                    </div>

                    <div class="bg-violet-50 p-6 rounded-2xl border border-violet-100">
                        <h3 class="font-bold text-violet-800 mb-4 flex items-center gap-2">
                            <span class="p-1.5 bg-white rounded-md shadow-sm">üí∞</span> Financial Ledger
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div><label class="text-xs font-bold text-slate-500">Fabric Cost</label><input type="number" id="costFabric" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-500">Dyeing Cost</label><input type="number" id="costDye" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-slate-500">Labor/Tailor</label><input type="number" id="costLabor" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                            <div><label class="text-xs font-bold text-violet-700 uppercase">Sale Price</label><input type="number" id="salePrice" required class="w-full border-2 border-violet-300 rounded-lg p-2 mt-1 font-bold"></div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeOrderModal()" class="px-8 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition">Discard</button>
                        <button type="submit" class="px-8 py-3 bg-violet-600 text-white rounded-xl hover:bg-violet-700 shadow-lg shadow-violet-200 font-bold transition">Save Order Record</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // Set by runtime
        let orders = JSON.parse(localStorage.getItem('boutique_orders_v2')) || [];

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemPrompt = "You are a professional boutique business and fashion expert.") {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            } catch (error) {
                console.error(error);
                return "AI service temporarily unavailable. Please try again.";
            }
        }

        async function generateDesignIdeas() {
            const item = document.getElementById('ai-item-input').value;
            const pref = document.getElementById('ai-pref-input').value;
            const output = document.getElementById('ai-design-output');
            const btn = document.getElementById('designBtn');
            
            if (!item) return alert("Please enter an item type.");

            btn.innerText = "‚ú® Consulting Gemini Designer...";
            btn.classList.add('ai-shimmer');
            output.innerHTML = "Crafting your design concepts...";

            const prompt = `Generate a detailed fashion design concept for a ${item}. 
            Customer preferences: ${pref}. 
            Provide:
            1. Fabric & Lining recommendations.
            2. Embroidery/Work details.
            3. Silhouette and cut suggestions.
            4. Accessory styling advice.
            Format with bold headings.`;

            const result = await callGemini(prompt, "You are a world-class high-end fashion designer specializing in custom boutiques.");
            output.innerHTML = `<div class="p-4 bg-white rounded-xl whitespace-pre-line text-slate-800">${result}</div>`;
            btn.innerText = "‚ú® Generate Design Concepts";
            btn.classList.remove('ai-shimmer');
        }

        async function aiAuditMeasurements() {
            const auditBox = document.getElementById('measurement-audit-result');
            const data = {
                item: document.getElementById('itemType').value,
                len: document.getElementById('mLength').value,
                bust: document.getElementById('mBust').value,
                waist: document.getElementById('mWaist').value,
                sh: document.getElementById('mShoulder').value,
                sleeve: document.getElementById('mSleeve').value,
                hip: document.getElementById('mHip').value,
            };

            auditBox.innerText = "‚ú® Gemini is auditing measurements for proportionality...";
            auditBox.classList.remove('hidden');

            const prompt = `As a master tailor, review these measurements for a ${data.item}: 
            Bust: ${data.bust}, Waist: ${data.waist}, Shoulder: ${data.sh}, Hip: ${data.hip}, Length: ${data.len}.
            Check for logical errors (e.g. waist bigger than bust usually means check twice, or shoulder too narrow for bust).
            If they look good, suggest the best neck style or flair for these proportions. Keep it under 60 words.`;

            const result = await callGemini(prompt, "You are a master tailor with 40 years of experience in custom pattern making.");
            auditBox.innerHTML = `<strong>‚ú® Tailor's Note:</strong> ${result}`;
        }

        async function aiBusinessAdvice() {
            const adviceBox = document.getElementById('ai-advice-container');
            const text = document.getElementById('ai-advice-text');
            
            adviceBox.classList.remove('hidden');
            text.innerText = "Analyzing your business data...";

            const summary = orders.map(o => ({ item: o.item, profit: o.profit, margin: (o.profit/o.salePrice*100).toFixed(0) }));
            const prompt = `Analyze these boutique orders: ${JSON.stringify(summary)}. 
            Identify: 
            1. Which item type has the best margins.
            2. Suggest one way to reduce costs (fabric, dyeing, or labor).
            3. Give a 1-sentence growth hack for a local boutique.`;

            const result = await callGemini(prompt, "You are a specialized business analyst for high-end boutiques.");
            text.innerText = result;
        }

        // --- EXISTING APP LOGIC ---

        function switchTab(tab) {
            ['dashboard', 'orders', 'analytics', 'ai-studio'].forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                document.getElementById(`tab-${s}`).classList.remove('tab-active');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            
            if(tab === 'analytics') renderAnalytics();
            if(tab === 'dashboard') renderDashboard();
        }

        function openOrderModal(editId = null) {
            document.getElementById('orderForm').reset();
            document.getElementById('measurement-audit-result').classList.add('hidden');
            document.getElementById('editId').value = editId || '';
            document.getElementById('modalTitle').innerText = editId ? 'Edit Order Record' : 'Create New Order';
            
            if(editId) {
                const o = orders.find(x => x.id == editId);
                document.getElementById('custName').value = o.customer;
                document.getElementById('itemType').value = o.item;
                document.getElementById('orderStatus').value = o.status || 'Pending';
                document.getElementById('mLength').value = o.measurements.len;
                document.getElementById('mBust').value = o.measurements.bust;
                document.getElementById('mWaist').value = o.measurements.waist;
                document.getElementById('mShoulder').value = o.measurements.shoulder;
                document.getElementById('mSleeve').value = o.measurements.sleeve;
                document.getElementById('mNeck').value = o.measurements.neck;
                document.getElementById('mHip').value = o.measurements.hip;
                document.getElementById('mOther').value = o.measurements.other;
                document.getElementById('costFabric').value = o.costs.fabric;
                document.getElementById('costDye').value = o.costs.dye;
                document.getElementById('costLabor').value = o.costs.labor;
                document.getElementById('salePrice').value = o.salePrice;
            }
            
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
        }

        function saveOrder(e) {
            e.preventDefault();
            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0;
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const sale = parseFloat(document.getElementById('salePrice').value) || 0;
            const totalCost = fabric + dye + labor;
            const profit = sale - totalCost;
            const editId = document.getElementById('editId').value;

            const orderData = {
                id: editId ? parseInt(editId) : Date.now(),
                date: editId ? orders.find(x => x.id == editId).date : new Date().toLocaleDateString(),
                customer: document.getElementById('custName').value,
                item: document.getElementById('itemType').value,
                status: document.getElementById('orderStatus').value,
                measurements: {
                    len: document.getElementById('mLength').value,
                    bust: document.getElementById('mBust').value,
                    waist: document.getElementById('mWaist').value,
                    shoulder: document.getElementById('mShoulder').value,
                    sleeve: document.getElementById('mSleeve').value,
                    neck: document.getElementById('mNeck').value,
                    hip: document.getElementById('mHip').value,
                    other: document.getElementById('mOther').value
                },
                costs: { fabric, dye, labor, totalCost },
                salePrice: sale,
                profit: profit
            };

            if(editId) {
                orders = orders.map(o => o.id == editId ? orderData : o);
            } else {
                orders.unshift(orderData);
            }

            localStorage.setItem('boutique_orders_v2', JSON.stringify(orders));
            closeOrderModal();
            renderOrders();
            renderDashboard();
            updateStats();
        }

        function updateOrderStatus(id, newStatus) {
            orders = orders.map(o => o.id === id ? {...o, status: newStatus} : o);
            localStorage.setItem('boutique_orders_v2', JSON.stringify(orders));
            renderOrders();
            renderDashboard();
            updateStats();
        }

        function updateStats() {
            const revenue = orders.reduce((sum, o) => sum + o.salePrice, 0);
            const profit = orders.reduce((sum, o) => sum + o.profit, 0);
            const pending = orders.filter(o => o.status === 'Pending' || o.status === 'Processing').length;
            const margin = revenue > 0 ? (profit / revenue * 100).toFixed(1) : 0;
            
            document.getElementById('stat-revenue').innerText = `‚Çπ${revenue.toLocaleString()}`;
            document.getElementById('stat-profit').innerText = `‚Çπ${profit.toLocaleString()}`;
            document.getElementById('stat-pending').innerText = pending;
            document.getElementById('stat-margin').innerText = `${margin}%`;
        }

        function renderOrders() {
            const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            const filtered = orders.filter(o => {
                const matchesSearch = o.customer.toLowerCase().includes(searchTerm) || o.item.toLowerCase().includes(searchTerm);
                const matchesFilter = filterStatus === 'all' || o.status === filterStatus;
                return matchesSearch && matchesFilter;
            });

            filtered.forEach(order => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-50";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${order.customer}</div>
                        <div class="text-xs text-slate-400 font-medium tracking-tight">${order.date}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-700 text-sm mb-1">${order.item}</div>
                        <select onchange="updateOrderStatus(${order.id}, this.value)" class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded border-none ${getStatusClass(order.status)}">
                            <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${order.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-xs text-slate-500 font-medium leading-relaxed">
                        L:${order.measurements.len}" B:${order.measurements.bust}" W:${order.measurements.waist}"<br>
                        Sh:${order.measurements.shoulder}" S:${order.measurements.sleeve}"
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-sm font-bold text-slate-800">‚Çπ${order.salePrice}</div>
                        <div class="text-[10px] font-bold ${order.profit >= 0 ? 'text-emerald-500' : 'text-red-500'}">PROFIT: ‚Çπ${order.profit}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-4">
                            <button onclick="openOrderModal(${order.id})" class="text-violet-400 hover:text-violet-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button onclick="deleteOrder(${order.id})" class="text-slate-300 hover:text-red-500 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderDashboard() {
            const container = document.getElementById('quick-orders');
            container.innerHTML = '';
            
            orders.slice(0, 6).forEach(o => {
                const div = document.createElement('div');
                div.className = "p-4 border rounded-xl flex justify-between items-center bg-white hover:border-violet-200 cursor-pointer transition";
                div.onclick = () => switchTab('orders');
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-slate-800 text-sm">${o.customer}</p>
                        <p class="text-xs text-slate-500">${o.item}</p>
                    </div>
                    <span class="text-[10px] font-bold px-2 py-1 rounded ${getStatusClass(o.status)}">${o.status}</span>
                `;
                container.appendChild(div);
            });
        }

        function renderAnalytics() {
            const totals = orders.reduce((acc, o) => {
                acc.fabric += o.costs.fabric;
                acc.dye += o.costs.dye;
                acc.labor += o.costs.labor;
                acc.profit += o.profit;
                return acc;
            }, { fabric: 0, dye: 0, labor: 0, profit: 0 });

            const totalMoney = totals.fabric + totals.dye + totals.labor + totals.profit;
            const getPercent = (val) => totalMoney > 0 ? (val / totalMoney * 100).toFixed(1) : 0;

            const container = document.getElementById('analytics-costs');
            container.innerHTML = `
                ${renderProgressBar('Fabric Costs', totals.fabric, 'bg-blue-400', getPercent(totals.fabric))}
                ${renderProgressBar('Dyeing Costs', totals.dye, 'bg-amber-400', getPercent(totals.dye))}
                ${renderProgressBar('Labor/Stitching', totals.labor, 'bg-slate-400', getPercent(totals.labor))}
                ${renderProgressBar('Net Profit', totals.profit, 'bg-emerald-400', getPercent(totals.profit))}
            `;

            document.getElementById('stat-avg-profit').innerText = orders.length > 0 ? `‚Çπ${Math.round(totals.profit / orders.length)}` : '‚Çπ0';
            
            const itemMap = {};
            orders.forEach(o => itemMap[o.item] = (itemMap[o.item] || 0) + o.profit);
            const topItem = Object.entries(itemMap).sort((a,b) => b[1]-a[1])[0];
            document.getElementById('stat-top-item').innerText = topItem ? topItem[0] : '-';
            
            const completed = orders.filter(o => o.status === 'Completed' || o.status === 'Delivered').length;
            document.getElementById('stat-conversion').innerText = orders.length > 0 ? `${Math.round(completed / orders.length * 100)}%` : '0%';
        }

        function renderProgressBar(label, value, colorClass, percent) {
            return `
                <div class="space-y-1">
                    <div class="flex justify-between text-xs font-bold">
                        <span class="text-slate-500 uppercase tracking-wide">${label}</span>
                        <span class="text-slate-800">‚Çπ${value.toLocaleString()} (${percent}%)</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2">
                        <div class="${colorClass} h-2 rounded-full" style="width: ${percent}%"></div>
                    </div>
                </div>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Pending': return 'status-pending';
                case 'Processing': return 'status-processing';
                case 'Completed': return 'status-completed';
                case 'Delivered': return 'status-delivered';
                default: return '';
            }
        }

        function deleteOrder(id) {
            if(confirm('Permanently delete this order?')) {
                orders = orders.filter(o => o.id !== id);
                localStorage.setItem('boutique_orders_v2', JSON.stringify(orders));
                renderOrders();
                renderDashboard();
                updateStats();
            }
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(orders));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `boutique_backup_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        orders = imported;
                        localStorage.setItem('boutique_orders_v2', JSON.stringify(orders));
                        location.reload();
                    }
                } catch(err) {
                    alert("Invalid backup file.");
                }
            };
            reader.readAsText(file);
        }

        window.onload = () => {
            updateStats();
            renderDashboard();
            renderOrders();
        };
    </script>
</body>
</html>
