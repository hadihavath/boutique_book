<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Book</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-active { border-bottom: 2px solid #8b5cf6; color: #8b5cf6; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-processing { background-color: #dbeafe; color: #1e40af; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-delivered { background-color: #f3f4f6; color: #374151; }
        .login-overlay { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); }
        /* Smooth Fade */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-8 relative min-h-screen text-slate-800">

    <div id="login-screen" class="fixed inset-0 z-[100] login-overlay flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 max-w-md w-full text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">Boutique Book</h1>
            <p class="text-slate-500 mb-8">Secure Cloud Workspace</p>
            <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 px-4 rounded-xl transition shadow-sm cursor-pointer">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight flex items-center gap-2">
                    Boutique Book 
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <div class="flex items-center px-2 py-1 bg-emerald-50 rounded-full border border-emerald-100">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
                        <p id="user-display" class="text-emerald-700 text-xs font-bold">Connecting...</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="logout()" class="px-4 py-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 border border-red-100 transition text-sm font-medium">Sign Out</button>
                <button onclick="exportData()" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition text-sm font-medium">Export CSV</button>
                <button onclick="openOrderModal()" class="px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700 shadow-md shadow-violet-200 transition font-medium flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> New Order
                </button>
            </div>
        </header>

        <div class="flex gap-8 border-b mb-8 overflow-x-auto">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-3 px-2 font-medium text-slate-500 tab-active">Overview</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="pb-3 px-2 font-medium text-slate-500">All Orders</button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="pb-3 px-2 font-medium text-slate-500">Financial Insights</button>
        </div>

        <div id="section-dashboard" class="space-y-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-b-4 border-violet-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Revenue</p>
                    <p id="stat-revenue" class="text-3xl font-bold text-slate-800">‚Çπ0</p>
                </div>
                <div class="card p-6 border-b-4 border-emerald-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Net Profit</p>
                    <p id="stat-profit" class="text-3xl font-bold text-emerald-600">‚Çπ0</p>
                </div>
                <div class="card p-6 border-b-4 border-amber-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pending Orders</p>
                    <p id="stat-pending" class="text-3xl font-bold text-amber-600">0</p>
                </div>
                <div class="card p-6 border-b-4 border-blue-500">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Profit Margin</p>
                    <p id="stat-margin" class="text-3xl font-bold text-blue-600">0%</p>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Quick Status Update</h3>
                <div id="quick-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <div id="section-orders" class="hidden card overflow-hidden fade-in">
            <div class="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-slate-800">Order Management</h2>
                <div class="flex gap-2 w-full md:w-auto">
                    <select id="filterStatus" onchange="renderOrders()" class="border rounded-md px-3 py-2 text-sm bg-white outline-none focus:ring-2 focus:ring-violet-500">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <input type="text" id="searchOrders" placeholder="Search name or item..." class="border rounded-md px-3 py-2 text-sm flex-grow md:w-64 outline-none focus:ring-2 focus:ring-violet-500" onkeyup="renderOrders()">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-bold">
                        <tr>
                            <th class="px-6 py-4">Customer & Date</th>
                            <th class="px-6 py-4">Item & Status</th>
                            <th class="px-6 py-4">Measurements</th>
                            <th class="px-6 py-4 text-right">Profit Analysis</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody" class="divide-y divide-slate-100">
                        <tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Loading secure data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="section-analytics" class="hidden space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 font-semibold mb-4 border-b pb-2">Expense Distribution</h3>
                    <div id="analytics-costs" class="space-y-4"></div>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 font-semibold border-b pb-2">Business Health</h3>
                    <div class="space-y-6 pt-4">
                        <div class="flex justify-between items-center"><span class="text-slate-500">Avg Profit/Order</span><span id="stat-avg-profit" class="font-bold text-slate-800">‚Çπ0</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500">Top Item</span><span id="stat-top-item" class="font-bold text-violet-600">-</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500">Conversion Rate</span><span id="stat-conversion" class="font-bold text-emerald-600">0%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-white px-8 py-5 border-b flex justify-between items-center z-10">
                <h2 class="text-2xl font-bold text-slate-800" id="modalTitle">Create New Order</h2>
                <button onclick="closeOrderModal()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            
            <div class="p-8 space-y-8">
                <input type="hidden" id="editId">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Customer Name *</label>
                        <input type="text" id="custName" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none transition bg-slate-50" placeholder="Required">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">WhatsApp Number</label>
                        <div class="flex items-center border rounded-xl overflow-hidden focus-within:ring-2 ring-violet-500 transition bg-slate-50">
                            <span class="bg-slate-100 text-slate-500 px-3 py-3 border-r text-sm font-bold border-slate-200">+91</span>
                            <input type="tel" id="custPhone" class="w-full p-3 outline-none bg-transparent" placeholder="9876543210">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Item Category *</label>
                        <input type="text" id="itemType" placeholder="e.g., Anarkali" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none transition bg-slate-50">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Status</label>
                        <select id="orderStatus" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-violet-500 outline-none bg-slate-50">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Completed">Completed</option>
                            <option value="Delivered">Delivered</option>
                        </select>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">üìè Precision Measurements (Inches)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Length</label><input type="text" id="mLength" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Chest</label><input type="text" id="mBust" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Waist</label><input type="text" id="mWaist" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Shoulder</label><input type="text" id="mShoulder" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Sleeve</label><input type="text" id="mSleeve" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Neck (F/B)</label><input type="text" id="mNeck" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Hip</label><input type="text" id="mHip" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase">Other</label><input type="text" id="mOther" class="w-full border rounded-lg p-2 mt-1"></div>
                    </div>
                </div>

                <div class="bg-violet-50 p-6 rounded-2xl border border-violet-100">
                    <h3 class="font-bold text-violet-800 mb-4 flex items-center gap-2">üí∞ Financial Ledger</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div><label class="text-xs font-bold text-slate-500">Fabric Cost</label><input type="number" id="costFabric" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-500">Dyeing Cost</label><input type="number" id="costDye" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-500">Labor/Tailor</label><input type="number" id="costLabor" value="0" class="w-full border rounded-lg p-2 mt-1"></div>
                        <div><label class="text-xs font-bold text-violet-700 uppercase">Sale Price *</label><input type="number" id="salePrice" class="w-full border-2 border-violet-300 rounded-lg p-2 mt-1 font-bold"></div>
                        <div class="md:col-span-4"><label class="text-xs font-bold text-emerald-700 uppercase">Advance Paid</label><input type="number" id="advance" value="0" class="w-full border-2 border-emerald-300 rounded-lg p-2 mt-1 font-bold text-emerald-700"></div>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button onclick="closeOrderModal()" class="px-8 py-3 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition cursor-pointer">Discard</button>
                    <button id="saveBtn" onclick="handleSave()" class="px-8 py-3 bg-violet-600 text-white rounded-xl hover:bg-violet-700 shadow-lg shadow-violet-200 font-bold transition cursor-pointer">Save Order Record</button>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsappModal" class="fixed inset-0 bg-slate-900/60 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-80 text-center">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
            </div>
            <h3 class="font-bold text-lg mb-2 text-slate-800">Send Invoice</h3>
            <p class="text-sm text-slate-500 mb-6" id="wa-display-num"></p>
            <input type="hidden" id="wa-order-id">
            <button onclick="sendWhatsapp()" class="w-full py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition cursor-pointer flex justify-center items-center gap-2">
                Send via WhatsApp
            </button>
            <button onclick="document.getElementById('whatsappModal').classList.add('hidden')" class="w-full mt-3 py-2 text-slate-400 text-sm hover:text-slate-600 cursor-pointer">Cancel</button>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCefM_p_lOAJilN0jDt3T5R5-FP4eKX9Ng",
            authDomain: "boutique-manager-hav.firebaseapp.com",
            projectId: "boutique-manager-hav",
            storageBucket: "boutique-manager-hav.firebasestorage.app",
            messagingSenderId: "1049576175326",
            appId: "1:1049576175326:web:68357d13c556102411b44f",
            measurementId: "G-L6G9WRCNXV",
            databaseURL: "https://boutique-manager-hav-default-rtdb.firebaseio.com"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let orders = [];

        // --- 2. HELPERS ---
        const safe = (str) => str ? String(str).replace(/</g, '&lt;') : '';

        // --- 3. AUTH ---
        function googleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
        function logout() { if(confirm("Log out?")) { auth.signOut(); location.reload(); } }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('user-display').innerText = user.displayName;
                db.ref('users/' + user.uid + '/orders').on('value', snap => {
                    const data = snap.val();
                    orders = data ? Object.values(data) : [];
                    renderOrders(); renderDashboard(); updateStats();
                });
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        // --- 4. APP LOGIC ---
        function handleSave() {
            if(!currentUser) return alert("Please login.");
            const cust = document.getElementById('custName').value;
            const item = document.getElementById('itemType').value;
            const price = document.getElementById('salePrice').value;

            if(!cust || !item || !price) return alert("Fill Name, Item, and Price.");

            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = "Saving...";
            btn.disabled = true;

            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0;
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const sale = parseFloat(price) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            const totalCost = fabric + dye + labor;
            const profit = sale - totalCost;
            const editId = document.getElementById('editId').value;
            const id = editId ? parseInt(editId) : Date.now();

            const orderData = {
                id: id,
                date: editId ? (orders.find(x => x.id == editId)?.date || new Date().toLocaleDateString()) : new Date().toLocaleDateString(),
                customer: cust,
                phone: document.getElementById('custPhone').value,
                item: item,
                status: document.getElementById('orderStatus').value,
                measurements: {
                    len: document.getElementById('mLength').value,
                    bust: document.getElementById('mBust').value,
                    waist: document.getElementById('mWaist').value,
                    shoulder: document.getElementById('mShoulder').value,
                    sleeve: document.getElementById('mSleeve').value,
                    neck: document.getElementById('mNeck').value,
                    hip: document.getElementById('mHip').value,
                    other: document.getElementById('mOther').value
                },
                costs: { fabric, dye, labor, totalCost },
                salePrice: sale, advance, profit
            };

            db.ref('users/' + currentUser.uid + '/orders/' + id).set(orderData)
                .then(() => { closeOrderModal(); btn.innerText = originalText; btn.disabled = false; })
                .catch(err => { alert(err.message); btn.innerText = originalText; btn.disabled = false; });
        }

        function deleteOrder(id) {
            if(confirm('Delete record?')) db.ref('users/' + currentUser.uid + '/orders/' + id).remove();
        }

        // --- 5. UI & WHATSAPP ---
        function renderOrders() {
            const term = document.getElementById('searchOrders').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            const filtered = orders.filter(o => {
                const matchSearch = (o.customer||'').toLowerCase().includes(term) || (o.item||'').toLowerCase().includes(term);
                const matchStatus = status === 'all' || o.status === status;
                return matchSearch && matchStatus;
            }).sort((a,b) => b.id - a.id);

            if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">No orders.</td></tr>`; return; }

            filtered.forEach(o => {
                const m = o.measurements || {};
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4"><div class="font-bold text-slate-800">${safe(o.customer)}</div><div class="text-xs text-slate-400">${safe(o.date)}</div></td>
                    <td class="px-6 py-4"><div class="font-semibold text-slate-700 text-sm">${safe(o.item)}</div><span class="text-[10px] font-bold px-2 py-1 rounded ${getStatusClass(o.status)}">${safe(o.status)}</span></td>
                    <td class="px-6 py-4 text-xs text-slate-500">L:${safe(m.len)||'-'} B:${safe(m.bust)||'-'} W:${safe(m.waist)||'-'}</td>
                    <td class="px-6 py-4 text-right"><div class="text-sm font-bold">‚Çπ${o.salePrice}</div><div class="text-[10px] ${o.profit>=0?'text-emerald-500':'text-red-500'}">PROFIT: ‚Çπ${o.profit}</div></td>
                    <td class="px-6 py-4 flex justify-center gap-2">
                        <button onclick="printInvoice(${o.id})" class="text-indigo-500 hover:bg-indigo-50 p-1.5 rounded" title="PDF"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button>
                        <button onclick="openWhatsappModal(${o.id})" class="text-green-500 hover:bg-green-50 p-1.5 rounded" title="WhatsApp"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.001.572 2.135.882 3.322.882 3.181 0 5.768-2.587 5.768-5.766-2.001-3.18-2.588-6.065-6.284-6.065z"/></svg></button>
                        <button onclick="openOrderModal(${o.id})" class="text-violet-400 hover:bg-violet-50 p-1.5 rounded" title="Edit"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                        <button onclick="deleteOrder(${o.id})" class="text-slate-300 hover:text-red-500 p-1.5 rounded" title="Delete"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openWhatsappModal(id) {
            const o = orders.find(x => x.id === id);
            if(!o.phone) return alert("No phone number saved for this customer.");
            document.getElementById('wa-display-num').innerText = "Send to: +91 " + o.phone;
            document.getElementById('wa-order-id').value = id;
            document.getElementById('whatsappModal').classList.remove('hidden');
        }

        function sendWhatsapp() {
            const id = parseInt(document.getElementById('wa-order-id').value);
            const o = orders.find(x => x.id === id);
            const balance = o.salePrice - (o.advance || 0);
            
            // Format: Invoice details
            const msg = `*INVOICE: ${o.customer}* %0A-----------------%0AItem: ${o.item}%0ATotal: ‚Çπ${o.salePrice}%0APaid: ‚Çπ${o.advance||0}%0A*Balance: ‚Çπ${balance}*%0A-----------------%0AThank you!`;
            
            window.open(`https://wa.me/91${o.phone}?text=${msg}`, '_blank');
            document.getElementById('whatsappModal').classList.add('hidden');
        }

        // --- 6. UTILS ---
        function getStatusClass(s) { if(s=='Pending')return'status-pending'; if(s=='Processing')return'status-processing'; if(s=='Completed')return'status-completed'; return 'status-delivered'; }
        
        function openOrderModal(editId=null) {
            document.querySelectorAll('#orderModal input').forEach(i=>i.value='');
            document.getElementById('orderStatus').value='Pending';
            document.getElementById('editId').value=editId||'';
            document.getElementById('modalTitle').innerText=editId?'Edit Order':'New Order';
            document.getElementById('saveBtn').innerText="Save Order";
            
            if(editId) {
                const o = orders.find(x=>x.id==editId);
                if(o) {
                    document.getElementById('custName').value=o.customer;
                    document.getElementById('custPhone').value=o.phone||'';
                    document.getElementById('itemType').value=o.item;
                    document.getElementById('orderStatus').value=o.status;
                    document.getElementById('salePrice').value=o.salePrice;
                    document.getElementById('advance').value=o.advance||0;
                    document.getElementById('costFabric').value=o.costs?.fabric||0;
                    document.getElementById('costDye').value=o.costs?.dye||0;
                    document.getElementById('costLabor').value=o.costs?.labor||0;
                    if(o.measurements) {
                        document.getElementById('mLength').value=o.measurements.len||'';
                        document.getElementById('mBust').value=o.measurements.bust||'';
                        document.getElementById('mWaist').value=o.measurements.waist||'';
                        document.getElementById('mShoulder').value=o.measurements.shoulder||'';
                        document.getElementById('mSleeve').value=o.measurements.sleeve||'';
                        document.getElementById('mNeck').value=o.measurements.neck||'';
                        document.getElementById('mHip').value=o.measurements.hip||'';
                        document.getElementById('mOther').value=o.measurements.other||'';
                    }
                }
            }
            document.getElementById('orderModal').classList.remove('hidden');
        }
        function closeOrderModal(){ document.getElementById('orderModal').classList.add('hidden'); }
        function switchTab(t){ ['dashboard','orders','analytics'].forEach(s=>{ document.getElementById('section-'+s).classList.add('hidden'); document.getElementById('tab-'+s).classList.remove('tab-active'); }); document.getElementById('section-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('tab-active'); if(t==='analytics') renderAnalytics(); if(t==='dashboard') renderDashboard(); }
        function updateStats(){ const rev=orders.reduce((s,o)=>s+(o.salePrice||0),0); const pro=orders.reduce((s,o)=>s+(o.profit||0),0); const pen=orders.filter(o=>o.status==='Pending'||o.status==='Processing').length; document.getElementById('stat-revenue').innerText=`‚Çπ${rev.toLocaleString()}`; document.getElementById('stat-profit').innerText=`‚Çπ${pro.toLocaleString()}`; document.getElementById('stat-pending').innerText=pen; document.getElementById('stat-margin').innerText=rev>0?(pro/rev*100).toFixed(1)+'%':'0%'; }
        function renderDashboard(){ const c=document.getElementById('quick-orders'); c.innerHTML=''; orders.slice(0,6).forEach(o=>{ c.innerHTML+=`<div onclick="switchTab('orders')" class="p-4 border rounded-xl flex justify-between items-center bg-white hover:border-violet-200 cursor-pointer transition"><div><p class="font-bold text-slate-800 text-sm">${safe(o.customer)}</p><p class="text-xs text-slate-500">${safe(o.item)}</p></div><span class="text-[10px] font-bold px-2 py-1 rounded ${getStatusClass(o.status)}">${safe(o.status)}</span></div>`}); }
        function printInvoice(id){ const o=orders.find(x=>x.id==id); if(!o)return; const doc=new window.jspdf.jsPDF(); doc.text("INVOICE",105,20,null,null,"center"); doc.text(`Customer: ${o.customer}`,20,40); doc.text(`Item: ${o.item}`,20,50); doc.text(`Total: ${o.salePrice}`,20,60); doc.save("invoice.pdf"); }
        function exportData(){ const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(orders)); const a=document.createElement('a'); a.href=s; a.download="backup.json"; a.click(); }
    </script>
</body>
</html>
