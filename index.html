<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Book Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --mouse-x: 0.5;
            --mouse-y: 0.5;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #fdf2f8; 
            overflow-x: hidden;
            color: #4a044e; 
        }

        /* --- VIBRANT FLORAL PARALLAX BACKGROUND --- */
        .floral-bg {
            position: fixed;
            top: -10%;
            left: -10%;
            width: 120%;
            height: 120%;
            z-index: -1;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23db2777' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E"),
                radial-gradient(circle at 80% 20%, rgba(232, 121, 249, 0.4), transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.3), transparent 40%);
            transform: translate(calc(var(--mouse-x) * -40px), calc(var(--mouse-y) * -40px));
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .card { 
            background: rgba(255, 255, 255, 0.75); 
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px; 
            box-shadow: 0 8px 32px 0 rgba(162, 28, 175, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .heading-font { font-family: 'Playfair Display', serif; }
        .tab-btn { position: relative; transition: all 0.3s; }
        .tab-btn::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px;
            background: linear-gradient(90deg, #d946ef, #8b5cf6); transition: width 0.3s;
        }
        .tab-active { color: #9333ea; font-weight: 700; }
        .tab-active::after { width: 100%; }

        .btn-gradient {
            background-image: linear-gradient(135deg, #d946ef 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            background-image: linear-gradient(135deg, #c026d3 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(147, 51, 234, 0.5);
        }

        .status-pending { background: #fff1f2; color: #be123c; border: 1px solid #fecdd3; }
        .status-processing { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
        .status-completed { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .status-delivered { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }

        input, select, textarea {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #d946ef;
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.1);
            background: #fff;
        }

        .login-overlay { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-scroll::-webkit-scrollbar { width: 6px; }
        .modal-scroll::-webkit-scrollbar-track { background: transparent; }
        .modal-scroll::-webkit-scrollbar-thumb { background: #e9d5ff; border-radius: 10px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #d8b4fe; }
    </style>
</head>
<body class="p-4 md:p-8 relative min-h-screen text-slate-800">

    <div class="floral-bg"></div>

    <div id="login-screen" class="fixed inset-0 z-[100] login-overlay flex flex-col items-center justify-center p-4">
        <div class="bg-white/80 p-10 rounded-3xl shadow-2xl border border-white max-w-md w-full text-center backdrop-blur-xl">
            <h1 class="text-4xl font-bold text-fuchsia-900 mb-2 heading-font">Boutique Book</h1>
            <p class="text-fuchsia-600/80 mb-8 font-medium">Elegant Management for Fashion</p>
            <button onclick="googleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border border-fuchsia-100 hover:bg-fuchsia-50 text-fuchsia-900 font-bold py-4 px-6 rounded-2xl transition shadow-lg cursor-pointer transform hover:scale-[1.02]">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                Sign in with Google
            </button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto opacity-0 transition-opacity duration-500 pointer-events-none">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div>
                <h1 class="text-4xl font-bold text-fuchsia-950 tracking-tight flex items-center gap-2 heading-font drop-shadow-sm">
                    Boutique Book 
                </h1>
                <div class="flex items-center gap-2 mt-2">
                    <div class="flex items-center px-3 py-1 bg-white/70 rounded-full border border-white/50 shadow-sm backdrop-blur-sm">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
                        <p id="user-display" class="text-emerald-800 text-xs font-bold uppercase tracking-wide">Connecting...</p>
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap justify-center gap-3">
                <button onclick="logout()" class="px-5 py-2.5 rounded-xl bg-white/80 text-rose-600 hover:bg-white border border-rose-100 shadow-sm transition text-sm font-bold backdrop-blur-md">Sign Out</button>
                <button onclick="exportCSV()" class="px-5 py-2.5 rounded-xl bg-white/80 text-violet-700 hover:bg-white border border-violet-100 shadow-sm transition text-sm font-bold flex items-center gap-2 backdrop-blur-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg> Export
                </button>
                <button onclick="openOrderModal()" class="px-6 py-2.5 rounded-xl btn-gradient text-white shadow-lg shadow-fuchsia-200 transition font-bold flex items-center gap-2 text-sm tracking-wide">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg> NEW ORDER
                </button>
            </div>
        </header>

        <div class="flex gap-8 border-b border-fuchsia-200/50 mb-10 overflow-x-auto px-2">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="pb-3 px-2 font-medium text-slate-500 tab-btn tab-active hover:text-fuchsia-700">Overview</button>
            <button onclick="switchTab('orders')" id="tab-orders" class="pb-3 px-2 font-medium text-slate-500 tab-btn hover:text-fuchsia-700">All Orders</button>
            <button onclick="switchTab('analytics')" id="tab-analytics" class="pb-3 px-2 font-medium text-slate-500 tab-btn hover:text-fuchsia-700">Financial Insights</button>
        </div>

        <div id="section-dashboard" class="space-y-8 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-t-4 border-fuchsia-500">
                    <p class="text-xs font-bold text-fuchsia-400 uppercase tracking-wider">Total Revenue</p>
                    <p id="stat-revenue" class="text-3xl font-bold text-slate-800 heading-font mt-1">‚Çπ0</p>
                </div>
                <div class="card p-6 border-t-4 border-emerald-500">
                    <p class="text-xs font-bold text-emerald-500 uppercase tracking-wider">Net Profit</p>
                    <p id="stat-profit" class="text-3xl font-bold text-emerald-700 heading-font mt-1">‚Çπ0</p>
                </div>
                <div class="card p-6 border-t-4 border-amber-500">
                    <p class="text-xs font-bold text-amber-500 uppercase tracking-wider">Pending</p>
                    <p id="stat-pending" class="text-3xl font-bold text-amber-600 heading-font mt-1">0</p>
                </div>
                <div class="card p-6 border-t-4 border-violet-500">
                    <p class="text-xs font-bold text-violet-500 uppercase tracking-wider">Margin</p>
                    <p id="stat-margin" class="text-3xl font-bold text-violet-600 heading-font mt-1">0%</p>
                </div>
            </div>

            <div id="urgent-container" class="hidden">
                <div class="bg-rose-50/80 backdrop-blur border border-rose-200 p-4 rounded-xl">
                    <h3 class="text-sm font-bold text-rose-700 mb-3 flex items-center gap-2 uppercase tracking-wide">
                        <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                        Upcoming Deliveries (3 Days)
                    </h3>
                    <div id="urgent-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>

            <div class="card p-8">
                <h3 class="text-xl font-bold text-fuchsia-900 mb-6 heading-font">Recent Activity</h3>
                <div id="quick-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <div id="section-orders" class="hidden card overflow-hidden fade-in">
            <div class="p-6 border-b border-fuchsia-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-white/40">
                <h2 class="text-xl font-bold text-fuchsia-900 heading-font">Order Management</h2>
                <div class="flex gap-3 w-full md:w-auto">
                    <select id="filterStatus" onchange="renderOrders()" class="rounded-xl px-4 py-2 text-sm text-fuchsia-900 font-medium cursor-pointer">
                        <option value="all">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Processing">Processing</option>
                        <option value="Completed">Completed</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <input type="text" id="searchOrders" placeholder="Search customer, item..." class="rounded-xl px-4 py-2 text-sm flex-grow md:w-64" onkeyup="renderOrders()">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-fuchsia-50/50 text-fuchsia-900/60 uppercase text-xs font-bold tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Client</th>
                            <th class="px-6 py-4">Item & Status</th>
                            <th class="px-6 py-4">Schedule</th>
                            <th class="px-6 py-4 text-right">Financials</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody" class="divide-y divide-fuchsia-100/50">
                        <tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Connecting to secure cloud...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="section-analytics" class="hidden space-y-6 fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-fuchsia-900 heading-font mb-6 border-b border-fuchsia-100 pb-2">Cost Breakdown</h3>
                    <div id="analytics-costs" class="space-y-5"></div>
                </div>
                <div class="card p-8">
                    <h3 class="text-lg font-bold text-fuchsia-900 heading-font mb-6 border-b border-fuchsia-100 pb-2">Business Health</h3>
                    <div class="space-y-6 pt-2">
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Avg Profit/Order</span><span id="stat-avg-profit" class="font-bold text-slate-800 text-lg">‚Çπ0</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Top Category</span><span id="stat-top-item" class="font-bold text-violet-600 text-lg">-</span></div>
                        <div class="flex justify-between items-center"><span class="text-slate-500 font-medium">Completion Rate</span><span id="stat-conversion" class="font-bold text-emerald-600 text-lg">0%</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-fuchsia-950/40 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-5xl w-full max-h-[95vh] overflow-y-auto shadow-2xl modal-scroll border border-white/60">
            <div class="sticky top-0 bg-white/95 backdrop-blur px-8 py-6 border-b border-fuchsia-100 flex justify-between items-center z-10">
                <div>
                    <h2 class="text-2xl font-bold text-fuchsia-950 heading-font" id="modalTitle">Create New Order</h2>
                    <p class="text-xs text-fuchsia-400 mt-1 font-medium tracking-wide" id="orderIdDisplay">ID Generated Automatically</p>
                </div>
                <button onclick="closeOrderModal()" class="text-slate-400 hover:text-rose-500 text-3xl transition transform hover:rotate-90">&times;</button>
            </div>
            
            <div class="p-8 space-y-8">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Customer Name *</label>
                        <input type="text" id="custName" class="w-full rounded-xl p-3" placeholder="Jane Doe">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">WhatsApp Number</label>
                        <div class="flex items-center border border-slate-200 rounded-xl overflow-hidden bg-white/90">
                            <span class="bg-fuchsia-50 text-fuchsia-700 px-3 py-3 border-r border-fuchsia-100 text-sm font-bold">+91</span>
                            <input type="tel" id="custPhone" class="w-full p-3 outline-none bg-transparent" placeholder="9876543210">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Status</label>
                        <select id="orderStatus" class="w-full rounded-xl p-3 cursor-pointer">
                            <option value="Pending">üïí Pending</option>
                            <option value="Processing">‚úÇÔ∏è Processing</option>
                            <option value="Completed">‚úÖ Completed</option>
                            <option value="Delivered">üì¶ Delivered</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Delivery Address</label>
                        <textarea id="custAddress" rows="2" class="w-full rounded-xl p-3" placeholder="Full address details..."></textarea>
                    </div>
                    
                    <div class="md:col-span-3 border-2 border-dashed border-fuchsia-200 rounded-2xl p-6 text-center hover:border-fuchsia-400 transition bg-fuchsia-50/30 cursor-pointer" onclick="document.getElementById('designImageInput').click()">
                        <label class="block text-xs font-bold text-fuchsia-400 uppercase mb-2 cursor-pointer">Design / Fabric Photo</label>
                        <input type="file" id="designImageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                        <div id="imagePreviewArea" class="flex flex-col items-center">
                            <svg id="uploadIcon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-fuchsia-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            <span id="uploadText" class="text-sm text-fuchsia-600 font-medium bg-white px-4 py-1 rounded-full shadow-sm">Click to upload</span>
                            <img id="designPreview" class="hidden max-h-48 rounded-xl shadow-lg mt-4 border-4 border-white">
                            <input type="hidden" id="designImageBase64">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Item Category *</label>
                        <input type="text" id="itemType" placeholder="e.g., Silk Saree" class="w-full rounded-xl p-3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Order Date</label>
                        <input type="date" id="dateOrder" class="w-full rounded-xl p-3 text-slate-600">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-fuchsia-900/60 uppercase mb-1">Delivery Due</label>
                        <input type="date" id="dateDelivery" class="w-full rounded-xl p-3 text-slate-600">
                    </div>
                </div>

                <div class="bg-fuchsia-50/50 p-6 rounded-2xl border border-fuchsia-100">
                    <h3 class="font-bold text-fuchsia-900 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <span class="bg-white p-1 rounded shadow-sm text-fuchsia-500">üìè</span> Measurements (Inches)
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Length</label><input type="text" id="mLength" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Chest</label><input type="text" id="mBust" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Waist</label><input type="text" id="mWaist" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Shoulder</label><input type="text" id="mShoulder" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Sleeve</label><input type="text" id="mSleeve" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Neck</label><input type="text" id="mNeck" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Hip</label><input type="text" id="mHip" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                        <div><label class="text-[10px] text-fuchsia-400 uppercase font-bold">Other</label><input type="text" id="mOther" class="w-full rounded-lg p-2 mt-1 text-sm border-fuchsia-200/50"></div>
                    </div>
                </div>

                <div class="bg-violet-50/50 p-6 rounded-2xl border border-violet-100">
                    <h3 class="font-bold text-violet-900 mb-4 flex items-center gap-2 text-sm uppercase tracking-wide">
                        <span class="bg-white p-1 rounded shadow-sm text-violet-500">üí∞</span> Costing & Billing
                    </h3>
                    
                    <div class="bg-white p-4 rounded-xl border border-violet-100 mb-4 shadow-sm">
                        <label class="block text-xs font-bold text-violet-400 uppercase mb-2">Fabric Calculator</label>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <select id="fabricType" class="w-full rounded p-2 text-sm border-violet-100">
                                    <option value="" disabled selected>Select Fabric</option>
                                    <option value="Silk">Silk</option>
                                    <option value="Cotton">Cotton</option>
                                    <option value="Georgette">Georgette</option>
                                    <option value="Velvet">Velvet</option>
                                    <option value="Organza">Organza</option>
                                    <option value="Net">Net</option>
                                    <option value="Crepe">Crepe</option>
                                    <option value="Linen">Linen</option>
                                    <option value="Chiffon">Chiffon</option>
                                    <option value="Satin">Satin</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div><input type="number" id="fabricPricePerM" placeholder="Price/M" class="w-full rounded p-2 text-sm border-violet-100" oninput="calcFabric()"></div>
                            <div><input type="number" id="fabricMeters" placeholder="Meters" class="w-full rounded p-2 text-sm border-violet-100" oninput="calcFabric()"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div><label class="text-xs font-bold text-slate-400">Total Fabric Cost</label><input type="number" id="costFabric" value="0" class="w-full rounded-lg p-2 mt-1 bg-slate-50 font-bold text-slate-600" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Dyeing Cost</label><input type="number" id="costDye" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Tailoring/Labor</label><input type="number" id="costLabor" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Handwork</label><input type="number" id="costHandwork" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Packing</label><input type="number" id="costPacking" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                        <div><label class="text-xs font-bold text-slate-400">Delivery</label><input type="number" id="costDelivery" value="0" class="w-full rounded-lg p-2 mt-1" oninput="calcTotal()"></div>
                    </div>
                    
                    <div class="border-t border-violet-200/50 my-6 pt-6 grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                        <div>
                            <label class="text-xs font-bold text-slate-400 uppercase">Total Expenses</label>
                            <p id="displayTotalCost" class="text-xl font-bold text-slate-500 mt-1">‚Çπ0</p>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-violet-700 uppercase">Final Sale Price *</label>
                            <input type="number" id="salePrice" class="w-full border-2 border-violet-300 rounded-xl p-3 mt-1 font-bold text-lg text-violet-900" oninput="calcTotal()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-emerald-700 uppercase">Advance Paid</label>
                            <input type="number" id="advance" value="0" class="w-full border-2 border-emerald-300 rounded-xl p-3 mt-1 font-bold text-emerald-700">
                        </div>
                        <div class="md:col-span-3 text-right pt-2">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Estimated Profit: </span>
                            <span id="displayProfit" class="text-2xl font-bold text-emerald-600 ml-2">‚Çπ0</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button onclick="closeOrderModal()" class="px-8 py-3.5 rounded-xl text-slate-500 hover:bg-slate-50 font-bold transition">Discard</button>
                    <button id="saveBtn" onclick="handleSave()" class="px-10 py-3.5 btn-gradient text-white rounded-xl shadow-lg shadow-violet-200 font-bold transition transform hover:scale-[1.02]">Save Order Record</button>
                </div>
            </div>
        </div>
    </div>

    <div id="whatsappModal" class="fixed inset-0 bg-fuchsia-950/50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-96 text-center border border-white">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
            </div>
            <h3 class="font-bold text-xl mb-1 text-slate-800 heading-font">Send Invoice</h3>
            <p class="text-sm text-slate-500 mb-8" id="wa-display-num"></p>
            <input type="hidden" id="wa-order-id">
            <button onclick="sendWhatsapp()" class="w-full py-4 bg-green-500 text-white rounded-2xl font-bold hover:bg-green-600 transition shadow-lg shadow-green-200 transform hover:scale-[1.02]">Download & Chat</button>
            <button onclick="document.getElementById('whatsappModal').classList.add('hidden')" class="w-full mt-4 py-2 text-slate-400 text-sm hover:text-slate-600 font-medium">Cancel</button>
        </div>
    </div>

    <script>
        document.addEventListener('mousemove', (e) => {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            document.body.style.setProperty('--mouse-x', x);
            document.body.style.setProperty('--mouse-y', y);
        });

        const firebaseConfig = {
            apiKey: "AIzaSyCefM_p_lOAJilN0jDt3T5R5-FP4eKX9Ng",
            authDomain: "boutique-manager-hav.firebaseapp.com",
            projectId: "boutique-manager-hav",
            storageBucket: "boutique-manager-hav.firebasestorage.app",
            messagingSenderId: "1049576175326",
            appId: "1:1049576175326:web:68357d13c556102411b44f",
            measurementId: "G-L6G9WRCNXV",
            databaseURL: "https://boutique-manager-hav-default-rtdb.firebaseio.com"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let orders = [];

        const safe = (str) => str ? String(str).replace(/</g, '&lt;') : '';
        function googleLogin() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); }
        function logout() { if(confirm("Log out?")) { auth.signOut(); location.reload(); } }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('user-display').innerText = user.displayName;
                db.ref('users/' + user.uid + '/orders').on('value', snap => {
                    const data = snap.val();
                    orders = data ? Object.values(data) : [];
                    renderOrders(); renderDashboard(); updateStats(); checkDeadlines();
                });
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        function calcFabric() {
            const price = parseFloat(document.getElementById('fabricPricePerM').value) || 0;
            const meter = parseFloat(document.getElementById('fabricMeters').value) || 0;
            document.getElementById('costFabric').value = (price * meter).toFixed(2);
            calcTotal();
        }

        function calcTotal() {
            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0;
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const handwork = parseFloat(document.getElementById('costHandwork').value) || 0;
            const pack = parseFloat(document.getElementById('costPacking').value) || 0;
            const delivery = parseFloat(document.getElementById('costDelivery').value) || 0;
            
            const total = fabric + dye + labor + handwork + pack + delivery;
            document.getElementById('displayTotalCost').innerText = `‚Çπ${total.toFixed(2)}`;
            
            const sale = parseFloat(document.getElementById('salePrice').value) || 0;
            const profit = sale - total;
            document.getElementById('displayProfit').innerText = `‚Çπ${profit.toFixed(2)}`;
            document.getElementById('displayProfit').className = profit >= 0 ? "text-2xl font-bold text-emerald-600 ml-2" : "text-2xl font-bold text-rose-600 ml-2";
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 500;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('designPreview').src = compressedBase64;
                        document.getElementById('designPreview').classList.remove('hidden');
                        document.getElementById('uploadText').innerText = "Image Selected";
                        document.getElementById('uploadIcon').classList.add('hidden');
                        document.getElementById('designImageBase64').value = compressedBase64;
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleSave() {
            if(!currentUser) return alert("Login required.");
            const cust = document.getElementById('custName').value;
            const item = document.getElementById('itemType').value;
            const price = document.getElementById('salePrice').value;

            if(!cust || !item || !price) return alert("Fill Name, Item, and Price.");

            const btn = document.getElementById('saveBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;

            const fabric = parseFloat(document.getElementById('costFabric').value) || 0;
            const dye = parseFloat(document.getElementById('costDye').value) || 0;
            const labor = parseFloat(document.getElementById('costLabor').value) || 0;
            const handwork = parseFloat(document.getElementById('costHandwork').value) || 0;
            const pack = parseFloat(document.getElementById('costPacking').value) || 0;
            const delivery = parseFloat(document.getElementById('costDelivery').value) || 0;
            const totalCost = fabric + dye + labor + handwork + pack + delivery;

            const sale = parseFloat(price) || 0;
            const advance = parseFloat(document.getElementById('advance').value) || 0;
            const profit = sale - totalCost;

            const editId = document.getElementById('editId').value;
            const id = editId ? parseInt(editId) : Date.now();
            const orderIdStr = editId ? orders.find(x=>x.id==editId).orderId : `ORD-${Date.now().toString().slice(-6)}`;

            const orderData = {
                id: id,
                orderId: orderIdStr,
                date: new Date().toLocaleDateString(),
                orderDate: document.getElementById('dateOrder').value,
                deliveryDate: document.getElementById('dateDelivery').value,
                customer: cust,
                phone: document.getElementById('custPhone').value,
                address: document.getElementById('custAddress').value,
                item: item,
                image: document.getElementById('designImageBase64').value,
                status: document.getElementById('orderStatus').value,
                measurements: {
                    len: document.getElementById('mLength').value,
                    bust: document.getElementById('mBust').value,
                    waist: document.getElementById('mWaist').value,
                    shoulder: document.getElementById('mShoulder').value,
                    sleeve: document.getElementById('mSleeve').value,
                    neck: document.getElementById('mNeck').value,
                    hip: document.getElementById('mHip').value,
                    other: document.getElementById('mOther').value
                },
                fabricDetails: {
                    type: document.getElementById('fabricType').value,
                    price: document.getElementById('fabricPricePerM').value,
                    meters: document.getElementById('fabricMeters').value
                },
                costs: { fabric, dye, labor, handwork, pack, delivery, totalCost },
                salePrice: sale, advance, profit
            };

            db.ref('users/' + currentUser.uid + '/orders/' + id).set(orderData)
                .then(() => { closeOrderModal(); btn.innerText = "Save Order Record"; btn.disabled = false; })
                .catch(err => { alert(err.message); btn.innerText = "Save Order Record"; btn.disabled = false; });
        }

        function deleteOrder(id) { if(confirm('Delete record?')) db.ref('users/' + currentUser.uid + '/orders/' + id).remove(); }

        function checkDeadlines() {
            const container = document.getElementById('urgent-orders');
            const alertBox = document.getElementById('urgent-container');
            container.innerHTML = '';
            
            const today = new Date();
            const urgent = orders.filter(o => {
                if(o.status === 'Completed' || o.status === 'Delivered' || !o.deliveryDate) return false;
                const due = new Date(o.deliveryDate);
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays <= 3; 
            });

            if(urgent.length > 0) {
                alertBox.classList.remove('hidden');
                urgent.forEach(o => {
                    const due = new Date(o.deliveryDate);
                    const isOverdue = due < today;
                    container.innerHTML += `
                        <div class="bg-white/90 p-4 rounded-xl shadow-sm border-l-4 ${isOverdue ? 'border-rose-500' : 'border-amber-500'} flex justify-between items-center cursor-pointer hover:shadow-md transition" onclick="openOrderModal(${o.id})">
                            <div>
                                <p class="font-bold text-sm text-slate-800">${safe(o.customer)}</p>
                                <p class="text-xs font-bold ${isOverdue ? 'text-rose-600' : 'text-amber-600'}">${isOverdue ? 'OVERDUE' : 'Due: ' + o.deliveryDate}</p>
                            </div>
                            <span class="text-[10px] font-bold px-2 py-1 bg-slate-100 rounded text-slate-600">${safe(o.status)}</span>
                        </div>
                    `;
                });
            } else {
                alertBox.classList.add('hidden');
            }
        }

        function openOrderModal(editId=null) {
            document.querySelectorAll('#orderModal input, #orderModal textarea, #orderModal select').forEach(i=>i.value='');
            document.getElementById('designPreview').classList.add('hidden');
            document.getElementById('uploadIcon').classList.remove('hidden');
            document.getElementById('uploadText').innerText = "Click to upload Design/Fabric photo";
            document.getElementById('designImageBase64').value = "";
            document.getElementById('orderStatus').value='Pending';
            document.getElementById('editId').value=editId||'';
            document.getElementById('modalTitle').innerText=editId?'Edit Order':'New Order';
            
            if(!editId) {
                document.getElementById('dateOrder').valueAsDate = new Date();
                document.getElementById('orderIdDisplay').innerText = `ID: ORD-${Date.now().toString().slice(-6)}`;
            }

            if(editId) {
                const o = orders.find(x=>x.id==editId);
                if(o) {
                    document.getElementById('orderIdDisplay').innerText = `ID: ${o.orderId || o.id}`;
                    document.getElementById('custName').value=o.customer;
                    document.getElementById('custPhone').value=o.phone||'';
                    document.getElementById('custAddress').value=o.address||'';
                    document.getElementById('itemType').value=o.item;
                    document.getElementById('orderStatus').value=o.status;
                    document.getElementById('dateOrder').value=o.orderDate||'';
                    document.getElementById('dateDelivery').value=o.deliveryDate||'';
                    document.getElementById('salePrice').value=o.salePrice;
                    document.getElementById('advance').value=o.advance||0;
                    
                    const c = o.costs || {};
                    document.getElementById('costFabric').value=c.fabric||0;
                    document.getElementById('costDye').value=c.dye||0;
                    document.getElementById('costLabor').value=c.labor||0;
                    document.getElementById('costHandwork').value=c.handwork||0;
                    document.getElementById('costPacking').value=c.pack||0;
                    document.getElementById('costDelivery').value=c.delivery||0;
                    
                    const f = o.fabricDetails || {};
                    document.getElementById('fabricType').value=f.type||'';
                    document.getElementById('fabricPricePerM').value=f.price||'';
                    document.getElementById('fabricMeters').value=f.meters||'';

                    if(o.image) {
                        document.getElementById('designPreview').src = o.image;
                        document.getElementById('designPreview').classList.remove('hidden');
                        document.getElementById('uploadIcon').classList.add('hidden');
                        document.getElementById('designImageBase64').value = o.image;
                    }

                    if(o.measurements) {
                        const m=o.measurements;
                        document.getElementById('mLength').value=m.len||'';
                        document.getElementById('mBust').value=m.bust||'';
                        document.getElementById('mWaist').value=m.waist||'';
                        document.getElementById('mShoulder').value=m.shoulder||'';
                        document.getElementById('mSleeve').value=m.sleeve||'';
                        document.getElementById('mNeck').value=m.neck||'';
                        document.getElementById('mHip').value=m.hip||'';
                        document.getElementById('mOther').value=m.other||'';
                    }
                    calcTotal();
                }
            }
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function closeOrderModal() { document.getElementById('orderModal').classList.add('hidden'); }

        function renderOrders() {
            const term = document.getElementById('searchOrders').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            const filtered = orders.filter(o => {
                const matchSearch = (o.customer||'').toLowerCase().includes(term) || (o.item||'').toLowerCase().includes(term) || (o.orderId||'').toLowerCase().includes(term);
                const matchStatus = status === 'all' || o.status === status;
                return matchSearch && matchStatus;
            }).sort((a,b) => b.id - a.id);

            if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">No active orders found.</td></tr>`; return; }

            filtered.forEach(o => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-fuchsia-50/50 border-b border-fuchsia-100/50 transition duration-200 group";
                
                const today = new Date();
                let dateStyle = "text-slate-500";
                if(o.deliveryDate) {
                    const due = new Date(o.deliveryDate);
                    if(due < today && o.status !== 'Delivered') dateStyle = "text-rose-600 font-bold bg-rose-50 px-2 py-1 rounded";
                }

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${safe(o.customer)}</div>
                        <div class="text-[10px] text-slate-400 font-mono tracking-wider">${o.orderId || o.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-slate-700 text-sm mb-1">${safe(o.item)}</div>
                        <span class="text-[10px] font-bold px-2.5 py-1 rounded-full ${getStatusClass(o.status)}">${safe(o.status)}</span>
                    </td>
                    <td class="px-6 py-4 text-xs ${dateStyle}">
                        <div class="flex flex-col gap-1">
                            <span>üìÖ Ord: ${o.orderDate || '-'}</span>
                            <span>üöö Del: ${o.deliveryDate || '-'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="text-sm font-bold text-slate-800">‚Çπ${o.salePrice}</div>
                        <div class="text-[10px] font-bold ${o.profit>=0?'text-emerald-500':'text-rose-500'}">PROFIT: ‚Çπ${o.profit?.toFixed(0)}</div>
                    </td>
                    <td class="px-6 py-4 flex justify-center gap-2 opacity-80 group-hover:opacity-100 transition">
                        <button onclick="printInvoice(${o.id})" class="text-indigo-500 hover:bg-indigo-50 p-2 rounded-lg transition" title="Invoice"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg></button>
                        <button onclick="openWhatsappModal(${o.id})" class="text-green-500 hover:bg-green-50 p-2 rounded-lg transition" title="WhatsApp"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.001.572 2.135.882 3.322.882 3.181 0 5.768-2.587 5.768-5.766-2.001-3.18-2.588-6.065-6.284-6.065z"/></svg></button>
                        <button onclick="openOrderModal(${o.id})" class="text-violet-500 hover:bg-violet-50 p-2 rounded-lg transition" title="Edit"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                        <button onclick="deleteOrder(${o.id})" class="text-rose-400 hover:bg-rose-50 p-2 rounded-lg transition" title="Delete"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchTab(t){ ['dashboard','orders','analytics'].forEach(s=>{ document.getElementById('section-'+s).classList.add('hidden'); document.getElementById('tab-'+s).classList.remove('tab-active'); }); document.getElementById('section-'+t).classList.remove('hidden'); document.getElementById('tab-'+t).classList.add('tab-active'); if(t==='analytics') renderAnalytics(); if(t==='dashboard') { renderDashboard(); checkDeadlines(); } }
        function updateStats(){ const rev=orders.reduce((s,o)=>s+(o.salePrice||0),0); const pro=orders.reduce((s,o)=>s+(o.profit||0),0); const pen=orders.filter(o=>o.status==='Pending'||o.status==='Processing').length; document.getElementById('stat-revenue').innerText=`‚Çπ${rev.toLocaleString()}`; document.getElementById('stat-profit').innerText=`‚Çπ${pro.toLocaleString()}`; document.getElementById('stat-pending').innerText=pen; document.getElementById('stat-margin').innerText=rev>0?(pro/rev*100).toFixed(1)+'%':'0%'; }
        function renderDashboard(){ const c=document.getElementById('quick-orders'); c.innerHTML=''; orders.slice(0,6).forEach(o=>{ c.innerHTML+=`<div onclick="switchTab('orders')" class="p-4 border-l-4 border-fuchsia-400 bg-white/80 rounded-r-xl flex justify-between items-center hover:bg-white cursor-pointer transition shadow-sm"><div><p class="font-bold text-slate-800 text-sm">${safe(o.customer)}</p><p class="text-xs text-slate-500">${safe(o.item)}</p></div><span class="text-[10px] font-bold px-2 py-1 rounded ${getStatusClass(o.status)}">${safe(o.status)}</span></div>`}); }
        function renderAnalytics() {
            const totals = orders.reduce((acc, o) => {
                const c = o.costs || {};
                acc.fabric += c.fabric || 0; acc.dye += c.dye || 0; acc.labor += c.labor || 0;
                acc.handwork += c.handwork || 0; acc.pack += c.pack || 0; acc.delivery += c.delivery || 0;
                return acc;
            }, { fabric:0, dye:0, labor:0, handwork:0, pack:0, delivery:0 });
            
            const totalExp = Object.values(totals).reduce((a,b)=>a+b,0);
            const getPct = (v) => totalExp > 0 ? (v/totalExp*100).toFixed(0) : 0;

            const container = document.getElementById('analytics-costs');
            container.innerHTML = `
                ${renderProgressBar('Fabric', totals.fabric, 'bg-blue-400', getPct(totals.fabric))}
                ${renderProgressBar('Labor/Stitching', totals.labor, 'bg-slate-400', getPct(totals.labor))}
                ${renderProgressBar('Handwork', totals.handwork, 'bg-purple-400', getPct(totals.handwork))}
                ${renderProgressBar('Dyeing', totals.dye, 'bg-amber-400', getPct(totals.dye))}
            `;
        }
        function renderProgressBar(l,v,c,p){ return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold text-slate-600"><span class="uppercase tracking-wide">${l}</span><span>‚Çπ${v.toLocaleString()} (${p}%)</span></div><div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="${c} h-2.5 rounded-full transition-all duration-500" style="width:${p}%"></div></div></div>`; }
        function getStatusClass(s) { if(s=='Pending')return'status-pending'; if(s=='Processing')return'status-processing'; if(s=='Completed')return'status-completed'; return 'status-delivered'; }

        function printInvoice(id){ 
            const o=orders.find(x=>x.id==id); if(!o)return; 
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); 
            doc.setFontSize(26); doc.setTextColor(134, 25, 143); doc.setFont("helvetica", "bold"); doc.text("INVOICE", 160, 25);
            doc.setFontSize(18); doc.setTextColor(74, 4, 78); doc.text("Boutique Book", 14, 25);
            
            doc.setDrawColor(240, 171, 252); doc.line(14, 35, 196, 35);
            
            doc.setFontSize(10); doc.setTextColor(100); doc.setFont("helvetica", "normal");
            doc.text(`Date: ${o.orderDate || o.date}`, 160, 45); doc.text(`ID: ${o.orderId || o.id}`, 160, 50);
            
            doc.setFontSize(11); doc.setTextColor(0); doc.setFont("helvetica", "bold"); doc.text(`Billed To:`, 14, 45);
            doc.setFont("helvetica", "normal"); doc.text(`${o.customer}`, 14, 52);
            doc.text(`+91 ${o.phone}`, 14, 58);
            const splitAddr = doc.splitTextToSize(o.address || '', 60);
            doc.text(splitAddr, 14, 64);

            if (o.measurements) {
                const m = o.measurements;
                doc.autoTable({ startY: 85, head: [['Length', 'Chest', 'Waist', 'Shldr', 'Sleeve']], body: [[m.len||'-', m.bust||'-', m.waist||'-', m.shoulder||'-', m.sleeve||'-']], theme: 'plain', styles: { fontSize: 9, cellPadding: 3 }, headStyles: { fontStyle: 'bold', textColor: 100 } });
            }

            doc.autoTable({
                startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 90,
                head: [['Item', 'Fabric', 'Due Date', 'Price']],
                body: [[o.item, o.fabricDetails?.type||'-', o.deliveryDate||'-', `Rs. ${o.salePrice}`]],
                theme: 'striped', headStyles: { fillColor: [192, 38, 211], textColor: 255 }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total:`, 150, finalY); doc.text(`Rs. ${o.salePrice}`, 190, finalY, {align:'right'});
            doc.text(`Advance:`, 150, finalY+6); doc.text(`- Rs. ${o.advance||0}`, 190, finalY+6, {align:'right'});
            doc.text(`Delivery:`, 150, finalY+12); doc.text(`+ Rs. ${o.costs?.delivery||0}`, 190, finalY+12, {align:'right'});
            doc.setDrawColor(200); doc.line(150, finalY+15, 190, finalY+15);
            doc.setFont("helvetica", "bold"); doc.setTextColor(134, 25, 143);
            doc.text(`Due:`, 150, finalY+22); doc.text(`Rs. ${(o.salePrice - (o.advance||0) + (o.costs?.delivery||0))}`, 190, finalY+22, {align:'right'});
            
            doc.setFont("helvetica", "italic"); doc.setFontSize(8); doc.setTextColor(150);
            doc.text("Thank you for your business. No refunds on custom orders.", 105, 280, {align:'center'});

            doc.save(`Invoice_${o.customer}_${o.orderId}.pdf`); 
        }

        function openWhatsappModal(id) {
            const o = orders.find(x => x.id === id);
            if(!o.phone) return alert("No phone number.");
            document.getElementById('wa-display-num').innerText = "Send to: +91 " + o.phone;
            document.getElementById('wa-order-id').value = id;
            document.getElementById('whatsappModal').classList.remove('hidden');
        }

        function sendWhatsapp() {
            const id = parseInt(document.getElementById('wa-order-id').value);
            const o = orders.find(x => x.id === id);
            printInvoice(id);
            const balance = (o.salePrice - (o.advance || 0) + (o.costs?.delivery||0));
            const msg = `*INVOICE: ${o.orderId}* %0A-----------------%0AItem: ${o.item}%0ATotal: ‚Çπ${o.salePrice}%0AAdvance: ‚Çπ${o.advance||0}%0A*Balance Due: ‚Çπ${balance}*%0A-----------------%0APlease find your invoice attached.`;
            setTimeout(() => { window.open(`https://wa.me/91${o.phone}?text=${msg}`, '_blank'); document.getElementById('whatsappModal').classList.add('hidden'); }, 1000);
        }

        function exportCSV() {
            if (!orders.length) return alert("No data.");
            const headers = ["Order ID", "Date", "Customer", "Phone", "Address", "Item", "Status", "Delivery Date", "Sale Price", "Advance", "Profit", "Fabric Cost", "Dye Cost", "Handwork", "Labor", "Packing", "Delivery Chg"];
            const rows = orders.map(o => {
                const c = o.costs || {};
                const esc = (t) => `"${String(t || '').replace(/"/g, '""')}"`;
                return [
                    o.orderId, o.orderDate, esc(o.customer), esc(o.phone), esc(o.address), esc(o.item), esc(o.status), o.deliveryDate,
                    o.salePrice, o.advance, o.profit, c.fabric, c.dye, c.handwork, c.labor, c.pack, c.delivery
                ].join(",");
            });
            const csv = "\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
            a.download = `Boutique_Orders_${new Date().toLocaleDateString()}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
